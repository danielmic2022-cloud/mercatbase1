
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestor de Clientes y Propiedades - MERCAT IMMOBILIARI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body {
    font-family: 'Inter', sans-serif;
    background-color: #f8f9fa; /* Default dark mode will override */
    transition: background-color 0.3s, color 0.3s;
}
.tab-content { display: none; }
.tab-content.active { display: block; }

/* --- BASE STYLES ( overridden by .dark or specific light mode) --- */
.btn-primary { background-color: #1a56db; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; font-weight: 500; transition: background-color 0.2s; }
.btn-primary:hover { background-color: #1e429f; }
.btn-secondary { background-color: #4b5563; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; font-weight: 500; transition: background-color 0.2s; }
.btn-secondary:hover { background-color: #374151; }

input[type="text"], input[type="number"], input[type="email"], input[type="tel"], input[type="url"], select, textarea {
    border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.625rem 0.75rem; width: 100%;
    transition: border-color 0.2s, box-shadow 0.2s;
}
input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #2563eb; /* blue-500 */
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
}
.form-group { margin-bottom: 1.25rem; }
.form-label { display: block; margin-bottom: 0.375rem; font-weight: 500; font-size: 0.875rem; }

.data-table { width: 100%; border-collapse: collapse; }
.data-table th, .data-table td { border: 1px solid #e5e7eb; padding: 0.75rem; text-align: left; vertical-align: middle; }
.data-table th { background-color: #f3f4f6; font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;}

.modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
.modal-content { background-color: #fff; margin: 5% auto; padding: 1.75rem; border-radius: 0.5rem; width: 90%; max-width: 700px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); position: relative; max-height: 90vh; overflow-y: auto; }
.close-modal-btn { color: #aaa; float: right; font-size: 32px; font-weight: bold; cursor: pointer; line-height: 1; }
.close-modal-btn:hover { color: #000; }

/* --- DARK MODE --- */
.dark { background-color: #111827; color: #d1d5db; } /* Tailwind gray-900, gray-300 */
    .dark .bg-white { background-color: #1f2937 !important; } /* gray-800 for cards */
    .dark .header-title { color: #f9fafb !important; } 
    .dark .header-subtitle { color: #9ca3af !important; } /* gray-400 */
    .dark .text-gray-700, .dark .text-gray-500, .dark .text-sm, .dark .text-gray-600 { color: #d1d5db !important; }
    .dark .form-control, .dark input, .dark select, .dark textarea { background-color: #374151; color: #f3f4f6; border-color: #4b5563; } /* gray-700, gray-200, gray-600 */
    .dark input::placeholder, .dark textarea::placeholder { color: #9ca3af; }
    .dark .btn-primary { background-color: #3b82f6; } /* blue-500 */
    .dark .btn-primary:hover { background-color: #2563eb; } /* blue-600 */
    .dark .btn-secondary { background-color: #4b5563; } /* gray-600 */
    .dark .btn-secondary:hover { background-color: #374151; } /* gray-700 */
    .dark .border-gray-200 { border-color: #374151 !important; } /* gray-700 */
    .dark .bg-gray-50 { background-color: #374151 !important; } /* gray-700 for light sections in dark mode */
    .dark .data-table th { background-color: #374151 !important; color: #f3f4f6 !important; }
    .dark .data-table td { border-color: #4b5563 !important; }
    .dark .data-table tr td { background-color: #1f2937 !important; }
    .dark .data-table tr:nth-child(even) td { background-color: #1a2332 !important; } /* Slightly different for even rows */
    .dark .modal-content { background-color: #1f2937; color: #d1d5db; }
    .dark .modal-content .text-gray-600, .dark .modal-content .text-gray-700 { color: #9ca3af !important; }
    .dark .modal-content .p-3.bg-gray-50 { background-color: #374151 !important; color: #d1d5db !important; }
    .dark .close-modal-btn { color: #9ca3af; }
    .dark .close-modal-btn:hover { color: #e5e7eb; }
    .dark .modal-content span:not([class*="text-"]) { color: #d1d5db; }
    .dark .modal-content h2, .dark .modal-content h3 { color: #f3f4f6 !important; }
    .dark #darkModeToggle { background-color: #374151; color: #d1d5db; }
    .dark #darkModeToggle:hover { background-color: #4b5563; }
    .dark .tab-btn { color: #9ca3af; }
    .dark .tab-btn.text-blue-600 { color: #60a5fa !important; } /* lighter blue for dark */
    .dark .tab-btn.border-blue-600 { border-color: #60a5fa !important; }
    .dark .tab-btn:hover:not(.text-blue-600) { color: #93c5fd; }
    /* Dark mode header sections */
    .dark .header-main-background { background-color: #1f2937; } /* gray-800 */
    .dark .header-tabs-background { background-color: #1f2937; /* border-bottom: 1px solid #374151; */ }
    .dark .header-tabs-background .border-t { border-color: #374151 !important; }


/* --- LIGHT MODE (when body does NOT have .dark) --- */
body:not(.dark) { background-color: #f3f4f6; color: #111827; } /* gray-100, gray-900 */
    body:not(.dark) .bg-white { background-color: #ffffff !important; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.05), 0 1px 2px 0 rgba(0,0,0,0.03); }
    /* Light mode header sections */
    body:not(.dark) .header-main-background { background-color: #2563eb; /* blue-600 */ }
    body:not(.dark) .header-main-background .header-title { color: #ffffff !important; }
    body:not(.dark) .header-main-background .header-subtitle { color: #dbeafe !important; /* blue-100 */ }
    body:not(.dark) .header-main-background #darkModeToggle { background-color: #1d4ed8; color: #ffffff; border: 1px solid #1e429f;}
    body:not(.dark) .header-main-background #darkModeToggle:hover { background-color: #1e429f; }
    body:not(.dark) .header-tabs-background { background-color: #ffffff; border-bottom: 1px solid #e5e7eb; }
    body:not(.dark) .header-tabs-background .border-t { border-color: transparent !important; } /* Hide top border if it looks weird */

    body:not(.dark) .text-gray-700, body:not(.dark) .text-gray-600 { color: #374151 !important; }
    body:not(.dark) .text-gray-500 { color: #6b7280 !important; }
    body:not(.dark) .form-control, body:not(.dark) input, body:not(.dark) select, body:not(.dark) textarea {
        background-color: #ffffff; color: #111827; border-color: #d1d5db;
    }
    body:not(.dark) input::placeholder, body:not(.dark) textarea::placeholder { color: #9ca3af; }
    body:not(.dark) .btn-primary { background-color: #2563eb; color: white; } /* blue-600 */
    body:not(.dark) .btn-primary:hover { background-color: #1d4ed8; } /* blue-700 */
    body:not(.dark) .btn-secondary { background-color: #e5e7eb; color: #374151; border: 1px solid #d1d5db; }
    body:not(.dark) .btn-secondary:hover { background-color: #d1d5db; }
    body:not(.dark) .border-gray-200 { border-color: #e5e7eb !important; }
    body:not(.dark) .bg-gray-50 { background-color: #f9fafb !important; }
    body:not(.dark) .data-table th { background-color: #f3f4f6 !important; color: #374151 !important; }
    body:not(.dark) .data-table td { border-color: #e5e7eb !important; }
    body:not(.dark) .data-table tr td { background-color: #ffffff !important; color: #1f2937; }
    body:not(.dark) .data-table tr:nth-child(even) td { background-color: #f9fafb !important; }
    body:not(.dark) .modal-content { background-color: #ffffff; color: #111827; }
    body:not(.dark) .modal-content .text-gray-600, body:not(.dark) .modal-content .text-gray-700 { color: #374151 !important; }
    body:not(.dark) .modal-content .p-3.bg-gray-50 { background-color: #f9fafb !important; color: #374151 !important; }
    body:not(.dark) .close-modal-btn { color: #6b7280; }
    body:not(.dark) .close-modal-btn:hover { color: #111827; }
    body:not(.dark) .modal-content span:not([class*="text-"]) { color: #1f2937; }
    body:not(.dark) .modal-content h2, body:not(.dark) .modal-content h3 { color: #111827 !important; }
    /* body:not(.dark) #darkModeToggle defined above with header-main-background */
    body:not(.dark) .tab-btn { color: #4b5563; }
    body:not(.dark) .tab-btn.text-blue-600 { color: #2563eb !important; }
    body:not(.dark) .tab-btn.border-blue-600 { border-color: #2563eb !important; }
    body:not(.dark) .tab-btn:hover:not(.text-blue-600) { color: #1d4ed8; }
    body:not(.dark) #cruceResults .border { border-color: #e5e7eb; }
    body:not(.dark) #cruceResults .text-blue-600 { color: #2563eb !important; }
    body:not(.dark) #cruceResults .text-gray-500 { color: #6b7280 !important; }
    body:not(.dark) #cruceResults .text-gray-600 { color: #4b5563 !important; }
    body:not(.dark) #cruceResults .border-b { border-color: #f3f4f6; }

.thumbnail-image { width: 150px; height: 100px; object-fit: cover; border-radius: 0.375rem; }
.property-image-preview { max-width: 250px; max-height: 180px; margin-top: 0.75rem; border: 1px solid #d1d5db; padding: 0.25rem; border-radius: 0.375rem; }
.dark .property-image-preview { border-color: #4b5563; }
.modal-property-image { max-width: 100%; max-height: 350px; object-fit: contain; margin-bottom: 1rem; border-radius: 0.375rem; }

.matched-property-thumbnail { 
    width: 150px; /* Increased */
    height: 110px; /* Increased */
    object-fit: cover; border-radius: 0.375rem; margin-right: 1rem; cursor: pointer; 
    border: 1px solid #e5e7eb;
}
.dark .matched-property-thumbnail { border-color: #4b5563; }

.btn-link {
    background-color: #10b981; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;
    text-decoration: none; display: inline-flex; align-items: center; font-weight: 500;
}
.btn-link:hover { background-color: #059669; }
.btn-link[disabled] { background-color: #9ca3af; cursor: not-allowed; }
body:not(.dark) .btn-link { background-color: #10b981; }
body:not(.dark) .btn-link:hover { background-color: #059669; }
body:not(.dark) .btn-link[disabled] { background-color: #d1d5db; color: #6b7280; }

#darkModeToggle { padding: 0.5rem; /* Smaller padding */ }
#darkModeToggle svg { height: 1.25rem; width: 1.25rem; } /* 5 in Tailwind units */

/* Estilo para el botón de WhatsApp */
.btn-whatsapp {
    background-color: #25D366; color: white; padding: 0.3rem 0.6rem; border-radius: 0.375rem;
    text-decoration: none; display: inline-flex; align-items: center; font-weight: 500;
    font-size: 0.75rem; /* text-xs */
    line-height: 1rem; /* text-xs */
    transition: background-color 0.2s;
}
.btn-whatsapp:hover { background-color: #1DA851; }
.btn-whatsapp svg { margin-right: 0.25rem; /* mr-1 */ }
.dark .btn-whatsapp { background-color: #128C7E; } /* Darker green for dark mode */
.dark .btn-whatsapp:hover { background-color: #075E54; }


</style>

</head>
<body class="dark"> <!-- Start with dark mode by default, JS will adjust -->
<header class="shadow-sm">
    <div class="header-main-background"> <!-- MODIFICADO: Div para fondo azul/oscuro -->
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
            <div class="text-center md:text-left mb-4 md:mb-0">
                <h1 class="header-title text-2xl font-bold uppercase">MERCAT IMMOBILIARI</h1>
                <p class="header-subtitle text-sm lowercase">Agente experto Daniel Hernández | tlf: 620809938 | email: daniel.mic2022@gmail.com</p>
            </div>
            <div class="flex space-x-2">
                <button id="darkModeToggle" class="rounded-md">
                    <!-- SVG icon will be dynamically set by JS -->
                </button>
            </div>
        </div>
    </div>
    <div class="header-tabs-background"> <!-- MODIFICADO: Div para fondo de pestañas -->
        <div class="border-t border-gray-200"> <!-- Este border-t se manejará por los estilos light/dark -->
            <div class="container mx-auto px-4">
                <!-- Nueva estructura de Navegación en Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-4 gap-y-2 py-3">
                    <button class="tab-btn text-gray-600 hover:text-blue-600 py-2 font-medium border-b-2 border-transparent w-full text-center" data-tab="compradores">Clientes Compradores</button>
                    <button class="tab-btn text-gray-600 hover:text-blue-600 py-2 font-medium border-b-2 border-transparent w-full text-center" data-tab="vendedores">Propiedades (Captadas/Colab.)</button>
                    <button class="tab-btn text-gray-600 hover:text-blue-600 py-2 font-medium border-b-2 border-transparent w-full text-center" data-tab="colaboradores">Colaboradores</button>

                    <button class="tab-btn text-gray-600 hover:text-blue-600 py-2 font-medium border-b-2 border-transparent w-full text-center" data-tab="database">Base de Datos Clientes</button>
                    <button class="tab-btn text-gray-600 hover:text-blue-600 py-2 font-medium border-b-2 border-transparent w-full text-center" data-tab="cruce">Cruce Clientes-Propiedades</button>
                    <button class="tab-btn text-gray-600 hover:text-blue-600 py-2 font-medium border-b-2 border-transparent w-full text-center" data-tab="seguimientoParticulares">Seguimiento Particulares</button>
                </div>
                <div class="flex justify-center py-2 pb-3">
                    <button class="tab-btn text-gray-600 hover:text-blue-600 px-3 py-2 font-medium border-b-2 border-transparent" data-tab="configuracion">Configuración</button>
                </div>
            </div>
        </div>
    </div>
</header>

<main class="container mx-auto px-4 py-8">
    <div id="compradoresTab" class="tab-content">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-6" id="formTitle">Añadir Nuevo Cliente Comprador</h2>
            <form id="buyerClientForm">
                <input type="hidden" id="clientId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                    <div class="form-group">
                        <label class="form-label" for="clientName">Nombre Completo</label>
                        <input type="text" id="clientName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="clientPhone">Teléfono</label>
                        <input type="tel" id="clientPhone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="clientEmail">Correo Electrónico</label>
                        <input type="email" id="clientEmail" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="clientPriceMax">Precio Máximo (€)</label>
                        <input type="number" id="clientPriceMax" class="form-control" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="clientZone">Zona(s) de Interés</label>
                        <input type="text" id="clientZone" class="form-control" placeholder="Ej: Centro, Playa, Montaña">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="mortgageApproved">Hipoteca Aprobada</label>
                        <select id="mortgageApproved" class="form-control">
                            <option value="no">No</option>
                            <option value="si">Sí</option>
                            <option value="en_proceso">En Proceso</option>
                            <option value="no_necesita">No Necesita</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label class="form-label" for="clientContribution">Aportación (€)</label>
                        <input type="number" id="clientContribution" class="form-control" min="0" placeholder="Aportación inicial del cliente">
                    </div>
                     <div class="form-group">
                        <label class="form-label" for="clientStatusForm">Estado del Cliente</label>
                        <select id="clientStatusForm" class="form-control">
                            <option value="seguimiento">Seguimiento</option>
                            <option value="activo">Activo</option>
                            <option value="no_activo">No Activo</option>
                            <option value="descartado">Descartado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="clientNumRooms">Nº de Habitaciones Deseadas</label>
                        <input type="text" id="clientNumRooms" class="form-control" placeholder="Ej: 3, 2 o 3, Estudio, 4+">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="clientElevator">Ascensor (Preferencia Cliente)</label>
                        <select id="clientElevator" class="form-control">
                            <option value="indiferente">Indiferente / No especificado</option>
                            <option value="si">Sí, es indispensable</option>
                            <option value="no">No es indispensable (OK sin él)</option>
                            <option value="no_indispensable_1">No indispensable hasta un 1º</option>
                            <option value="no_indispensable_2">No indispensable hasta un 2º</option>
                            <option value="no_indispensable_3">No indispensable hasta un 3º</option>
                            <option value="no_indispensable_4">No indispensable hasta un 4º</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="clientMinSqMeters">Metros Mínimos (m²)</label>
                        <input type="number" id="clientMinSqMeters" class="form-control" min="0" placeholder="Ej: 70">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="clientMaxSqMeters">Metros Máximos (m²)</label>
                        <input type="number" id="clientMaxSqMeters" class="form-control" min="0" placeholder="Ej: 120">
                    </div>
                </div>
                <div class="form-group mt-6 col-span-1 md:col-span-2">
                    <label class="form-label" for="clientComments">Comentarios Adicionales (Cliente)</label>
                    <textarea id="clientComments" rows="4" class="form-control"></textarea>
                </div>
                <div class="mt-8 flex space-x-3">
                    <button type="button" id="saveClientBtn" class="btn-primary">Guardar Cliente</button>
                    <button type="button" id="newClientBtn" class="btn-secondary">Nuevo Cliente (Limpiar Formulario)</button>
                </div>
            </form>
        </div>
    </div>

    <div id="vendedoresTab" class="tab-content"> <!-- Renombrada para claridad -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-6" id="propertyFormTitle">Añadir Nueva Propiedad (Captada/Colaborador)</h2>
            <form id="propertyForm">
                <input type="hidden" id="propertyId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                    <div class="form-group">
                        <label class="form-label" for="propertyAddress">Dirección / Referencia</label>
                        <input type="text" id="propertyAddress" class="form-control" required placeholder="Ej: Calle Falsa 123, Ático B">
                    </div>
                     <div class="form-group">
                        <label class="form-label" for="propertyPrice">Precio de Venta (€)</label>
                        <input type="number" id="propertyPrice" class="form-control" min="0" required>
                    </div>
                     <div class="form-group">
                        <label class="form-label" for="sellerName">Nombre Vendedor/Agencia</label>
                        <input type="text" id="sellerName" class="form-control" placeholder="Nombre del particular o de la agencia">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="sellerPhone">Teléfono del Vendedor/Agencia</label>
                        <input type="tel" id="sellerPhone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="sellerType">Tipo de Vendedor/Origen</label>
                        <select id="sellerType" class="form-control">
                            <option value="particular">Particular (Captación propia)</option>
                            <option value="agencia">Agencia (Colaborador)</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label class="form-label" for="propertyFloor">Planta del Inmueble</label>
                        <input type="text" id="propertyFloor" class="form-control" placeholder="Ej: Bajo, Entresuelo, 1º, 3ºB, Ático">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="propertySqMeters">Metros Cuadrados (m²)</label>
                        <input type="number" id="propertySqMeters" class="form-control" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="propertyRooms">Nº de Habitaciones</label>
                        <input type="number" id="propertyRooms" class="form-control" min="0" placeholder="Ej: 3">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="propertyBaths">Nº de Baños</label>
                        <input type="number" id="propertyBaths" class="form-control" min="0" placeholder="Ej: 2">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="propertyElevator">Ascensor</label>
                        <select id="propertyElevator" class="form-control">
                            <option value="indiferente">Indiferente / No consta</option>
                            <option value="si">Sí Tiene</option>
                            <option value="no">No Tiene</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="propertyURL">URL Anuncio (Opcional)</label>
                        <input type="url" id="propertyURL" class="form-control" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="propertyImageFile">Imagen de la Propiedad (PNG, JPG)</label>
                        <input type="file" id="propertyImageFile" class="form-control" accept="image/png, image/jpeg">
                        <img id="propertyImagePreview" src="#" alt="Vista previa de imagen" class="property-image-preview hidden"/>
                    </div>
                </div>
                <div class="form-group mt-6 col-span-1 md:col-span-2">
                    <label class="form-label" for="propertyComments">Comentarios (Propiedad)</label>
                    <textarea id="propertyComments" rows="4" class="form-control"></textarea>
                </div>
                <div class="mt-8 flex space-x-3">
                    <button type="button" id="savePropertyBtn" class="btn-primary">Guardar Propiedad</button>
                    <button type="button" id="newPropertyBtn" class="btn-secondary">Nueva Propiedad (Limpiar)</button>
                </div>
            </form>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-6">Listado de Propiedades (Captadas/Colaboradores)</h2>
            <div class="overflow-x-auto">
                <table id="propertiesTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Dirección</th>
                            <th>Precio</th>
                            <th>Vendedor/Agencia</th>
                            <th>Tlf. Vendedor</th>
                            <th>Origen</th>
                            <th>Planta</th>
                            <th>m²</th>
                            <th>Hab.</th>
                            <th>Baños</th>
                            <th>Ascensor</th>
                            <th>URL</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="noPropertiesMessage" class="py-8 text-center text-gray-500" style="display: none;">
                No hay propiedades en la base de datos.
            </div>
        </div>
    </div>

    <div id="seguimientoParticularesTab" class="tab-content">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-6" id="privateSellerFormTitle">Añadir Vendedor Particular para Seguimiento</h2>
            <form id="privateSellerForm">
                <input type="hidden" id="privateSellerId">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                    <div class="form-group">
                        <label class="form-label" for="privateSellerOwnerName">Nombre Propietario</label>
                        <input type="text" id="privateSellerOwnerName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="privateSellerOwnerPhone">Teléfono Propietario</label>
                        <input type="tel" id="privateSellerOwnerPhone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="privateSellerOwnerEmail">Email Propietario</label>
                        <input type="email" id="privateSellerOwnerEmail" class="form-control">
                    </div>
                     <div class="form-group">
                        <label class="form-label" for="privateSellerStatus">Estado Seguimiento</label>
                        <select id="privateSellerStatus" class="form-control">
                            <option value="seguimiento">Seguimiento</option>
                            <option value="activo">Contactado (Interesado)</option>
                            <option value="no_activo">Contactado (No Interesado)</option>
                            <option value="descartado">Descartado / Vendido por otro</option>
                        </select>
                    </div>
                    <div class="form-group md:col-span-2">
                        <label class="form-label" for="privateSellerPropertyAddress">Dirección Inmueble</label>
                        <input type="text" id="privateSellerPropertyAddress" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="privateSellerPropertyZone">Zona Inmueble</label>
                        <input type="text" id="privateSellerPropertyZone" class="form-control" placeholder="Ej: Centro, Ensanche">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="privateSellerPropertyFloor">Planta Inmueble</label>
                        <input type="text" id="privateSellerPropertyFloor" class="form-control" placeholder="Ej: 3º, Bajo, Ático">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="privateSellerPropertyRooms">Nº Habitaciones</label>
                        <input type="number" id="privateSellerPropertyRooms" class="form-control" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="privateSellerPropertySqMeters">Metros Cuadrados (m²)</label>
                        <input type="number" id="privateSellerPropertySqMeters" class="form-control" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="privateSellerPropertyElevator">Ascensor</label>
                        <select id="privateSellerPropertyElevator" class="form-control">
                            <option value="indiferente">Indiferente / No consta</option>
                            <option value="si">Sí Tiene</option>
                            <option value="no">No Tiene</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="privateSellerPropertyURL">URL Anuncio (Idealista, etc.)</label>
                        <input type="url" id="privateSellerPropertyURL" class="form-control" placeholder="https://...">
                    </div>
                    <div class="form-group md:col-span-2">
                        <label class="form-label" for="privateSellerPropertyImageFile">Imagen Inmueble (Opcional)</label>
                        <input type="file" id="privateSellerPropertyImageFile" class="form-control" accept="image/png, image/jpeg">
                        <img id="privateSellerPropertyImagePreview" src="#" alt="Vista previa imagen" class="property-image-preview hidden"/>
                    </div>
                 </div>
                <div class="form-group mt-6 col-span-1 md:col-span-2">
                    <label class="form-label" for="privateSellerComments">Comentarios (Seguimiento)</label>
                    <textarea id="privateSellerComments" rows="3" class="form-control"></textarea>
                </div>
                <div class="mt-8 flex space-x-3">
                    <button type="button" id="savePrivateSellerBtn" class="btn-primary">Guardar Vendedor Particular</button>
                    <button type="button" id="newPrivateSellerBtn" class="btn-secondary">Nuevo (Limpiar)</button>
                </div>
            </form>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-6">Listado de Vendedores Particulares en Seguimiento</h2>
            <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-5 items-end">
                <div class="form-group m-0">
                    <label for="filterPrivateSellerStatus" class="form-label text-sm">Filtrar por estado</label>
                    <select id="filterPrivateSellerStatus" class="form-control">
                        <option value="todos">Todos</option>
                        <option value="seguimiento">Seguimiento</option>
                        <option value="activo">Contactado (Interesado)</option>
                        <option value="no_activo">Contactado (No Interesado)</option>
                        <option value="descartado">Descartado / Vendido por otro</option>
                    </select>
                </div>
                <div class="form-group m-0">
                    <label for="filterPrivateSellerZone" class="form-label text-sm">Filtrar por zona inmueble</label>
                    <input type="text" id="filterPrivateSellerZone" class="form-control" placeholder="Buscar por zona">
                </div>
                 <div class="md:col-span-3 mt-4">
                    <button id="resetPrivateSellerFiltersBtn" class="btn-secondary w-full md:w-auto">Resetear Filtros</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table id="privateSellersTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Propietario</th>
                            <th>Teléfono</th>
                            <th>Dirección Inmueble</th>
                            <th>Zona</th>
                            <th>Hab.</th>
                            <th>m²</th>
                            <th>Ascensor</th>
                            <th>Estado</th>
                            <th>URL</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="noPrivateSellersMessage" class="py-8 text-center text-gray-500" style="display: none;">
                No hay vendedores particulares en seguimiento o que coincidan con los filtros.
            </div>
        </div>
    </div>
    
    <div id="colaboradoresTab" class="tab-content">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-6" id="collaboratorFormTitle">Añadir Nuevo Colaborador</h2>
            <form id="collaboratorForm">
                <input type="hidden" id="collaboratorId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                    <div class="form-group">
                        <label class="form-label" for="collaboratorName">Nombre del Colaborador</label>
                        <input type="text" id="collaboratorName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="collaboratorAgencyName">Nombre de la Agencia</label>
                        <input type="text" id="collaboratorAgencyName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="collaboratorPhone">Teléfono</label>
                        <input type="tel" id="collaboratorPhone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="collaboratorEmail">Correo Electrónico</label>
                        <input type="email" id="collaboratorEmail" class="form-control">
                    </div>
                    <div class="form-group md:col-span-2">
                        <label class="form-label" for="collaboratorAddress">Dirección</label>
                        <input type="text" id="collaboratorAddress" class="form-control">
                    </div>
                    <div class="form-group md:col-span-2">
                        <label class="form-label" for="collaboratorURL">URL (Página Web, Perfil, etc.)</label>
                        <input type="url" id="collaboratorURL" class="form-control" placeholder="https://...">
                    </div>
                </div>
                <div class="form-group mt-6 col-span-1 md:col-span-2">
                    <label class="form-label" for="collaboratorComments">Comentarios Adicionales</label>
                    <textarea id="collaboratorComments" rows="4" class="form-control"></textarea>
                </div>
                <div class="mt-8 flex space-x-3">
                    <button type="button" id="saveCollaboratorBtn" class="btn-primary">Guardar Colaborador</button>
                    <button type="button" id="newCollaboratorBtn" class="btn-secondary">Nuevo Colaborador (Limpiar)</button>
                </div>
            </form>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-6">Listado de Colaboradores</h2>
            <div class="overflow-x-auto">
                <table id="collaboratorsTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Nombre Colaborador</th>
                            <th>Agencia</th>
                            <th>Teléfono</th>
                            <th>Email</th>
                            <th>Dirección</th>
                            <th>URL</th>
                            <th>Documento</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="noCollaboratorsMessage" class="py-8 text-center text-gray-500" style="display: none;">
                No hay colaboradores en la base de datos.
            </div>
        </div>
    </div>

    <div id="cruceTab" class="tab-content">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-6">Cruce de Clientes Compradores con Propiedades (Captadas/Colab.)</h2>
            <button id="performCruceBtn" class="btn-primary mb-8">Realizar Cruce Ahora</button>
            <div id="cruceResults" class="space-y-8">
                <p class="text-gray-500">Pulse "Realizar Cruce Ahora" para ver los resultados.</p>
            </div>
        </div>
    </div>

    <div id="databaseTab" class="tab-content">
         <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-6">Listado de Clientes Compradores</h2>
            <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-5 items-end">
                <div class="form-group m-0">
                    <label for="filterStatus" class="form-label text-sm">Filtrar por estado</label>
                    <select id="filterStatus" class="form-control">
                        <option value="todos">Todos</option>
                        <option value="activo">Activo</option>
                        <option value="no_activo">No Activo</option>
                        <option value="seguimiento">Seguimiento</option>
                        <option value="descartado">Descartado</option>
                    </select>
                </div>
                <div class="form-group m-0">
                    <label for="filterZone" class="form-label text-sm">Filtrar por zona</label>
                    <input type="text" id="filterZone" class="form-control" placeholder="Buscar por zona">
                </div>
                 <div class="form-group m-0">
                    <label for="filterNumRooms" class="form-label text-sm">Nº Habitaciones (Cliente)</label>
                    <select id="filterNumRooms" class="form-control">
                        <option value="todos">Todas</option>
                        <option value="0">0 (Estudio)</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5+</option>
                    </select>
                </div>
                <div class="form-group m-0">
                    <label for="filterPriceMin" class="form-label text-sm">Precio Máx. Cliente (€) Desde</label>
                    <input type="number" id="filterPriceMin" class="form-control" placeholder="Mínimo">
                </div>
                <div class="form-group m-0">
                    <label for="filterPriceMax" class="form-label text-sm">Precio Máx. Cliente (€) Hasta</label>
                    <input type="number" id="filterPriceMax" class="form-control" placeholder="Máximo">
                </div>
                <div class="form-group m-0">
                    <label for="filterElevator" class="form-label text-sm">Ascensor (Preferencia Cliente)</label>
                    <select id="filterElevator" class="form-control">
                        <option value="todos">Todos</option>
                        <option value="si">Sí (Indispensable)</option>
                        <option value="no">No indispensable (General)</option>
                        <option value="no_indispensable_1">No indispensable hasta un 1º</option>
                        <option value="no_indispensable_2">No indispensable hasta un 2º</option>
                        <option value="no_indispensable_3">No indispensable hasta un 3º</option>
                        <option value="no_indispensable_4">No indispensable hasta un 4º</option>
                        <option value="indiferente">Indiferente</option>
                    </select>
                </div>
                <div class="md:col-span-3 mt-4">
                    <button id="resetFiltersBtn" class="btn-secondary w-full md:w-auto">Resetear Filtros</button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table id="clientsTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Teléfono</th>
                            <th>Email</th>
                            <th>Precio Máx.</th>
                            <th>Aportación</th>
                            <th>Zona</th>
                            <th>Hipoteca</th>
                            <th>Estado</th>
                            <th>Hab. Des.</th>
                            <th>Ascensor Pref.</th>
                            <th>m² Min</th>
                            <th>m² Max</th>
                            <th>Documento</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="noDataMessage" class="py-8 text-center text-gray-500" style="display: none;">
                No hay clientes en la base de datos que coincidan con los filtros.
            </div>
        </div>
    </div>

    <div id="configuracionTab" class="tab-content">
         <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-6">Configuración de Datos</h2>
            <div class="mb-8 p-6 border border-gray-200 dark:border-gray-700 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">Gestión de Base de Datos (JSON)</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Exporta todos los datos (clientes, propiedades, colaboradores y seguimiento particulares) a un archivo JSON o importa datos desde un archivo JSON para restaurar o reemplazar la base de datos actual.</p>
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                    <button id="exportJsonBtn" class="btn-primary w-full sm:w-auto">Exportar a JSON</button>
                    <button id="importJsonTriggerBtn" class="btn-secondary w-full sm:w-auto">Importar desde JSON</button>
                    <input type="file" id="importJsonInput" class="hidden" accept=".json">
                </div>
            </div>
            <div class="p-6 border border-gray-200 dark:border-gray-700 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">Gestión de Base de Datos (XLSX - Excel)</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Exporta los datos (clientes, propiedades, colaboradores y seguimiento particulares en hojas separadas) a un archivo XLSX o importa datos desde un archivo XLSX.</p>
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                    <button id="exportXlsxBtn" class="btn-primary w-full sm:w-auto">Exportar a XLSX</button>
                    <button id="importXlsxTriggerBtn" class="btn-secondary w-full sm:w-auto">Importar desde XLSX</button>
                    <input type="file" id="importXlsxInput" class="hidden" accept=".xlsx, .xls">
                </div>
            </div>
        </div>
    </div>
</main>

<div id="clientDetailsModal" class="modal">
    <div class="modal-content">
        <span class="close-modal-btn" onclick="closeModal('clientDetailsModal')">×</span>
        <h2 class="text-xl font-bold mb-6">Detalles de <span id="modalClientName">Cliente</span></h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
            <div><strong class="text-gray-600">Teléfono:</strong> <span id="modalClientPhone">-</span></div>
            <div><strong class="text-gray-600">Email:</strong> <span id="modalClientEmail">-</span></div>
            <div><strong class="text-gray-600">Precio Máx.:</strong> <span id="modalClientPriceMax">-</span></div>
            <div><strong class="text-gray-600">Aportación:</strong> <span id="modalClientContribution">-</span></div>
            <div class="md:col-span-2"><strong class="text-gray-600">Zona(s):</strong> <span id="modalClientZone">-</span></div>
            <div><strong class="text-gray-600">Hipoteca Aprobada:</strong> <span id="modalMortgageApproved">-</span></div>
            <div><strong class="text-gray-600">Estado:</strong> <span id="modalClientStatus">-</span></div>
            <div><strong class="text-gray-600">Nº Habitaciones Des.:</strong> <span id="modalClientNumRooms">-</span></div>
            <div><strong class="text-gray-600">Ascensor Pref.:</strong> <span id="modalClientElevator">-</span></div>
            <div><strong class="text-gray-600">Metros Mínimos:</strong> <span id="modalClientMinSqMeters">-</span><span id="modalClientMinSqMetersUnit"></span></div>
            <div><strong class="text-gray-600">Metros Máximos:</strong> <span id="modalClientMaxSqMeters">-</span><span id="modalClientMaxSqMetersUnit"></span></div>
        </div>
        <div class="mt-6">
            <h3 class="text-lg font-semibold mb-2">Comentarios (Cliente)</h3>
            <div id="modalClientComments" class="p-3 bg-gray-50 rounded-md text-gray-700 min-h-[80px] whitespace-pre-wrap">-</div>
        </div>
        <div id="modalClientPdfSection" class="mt-4 hidden">
            <button id="modalClientViewPdfBtn" class="btn-secondary text-sm" data-client-id="">Ver PDF Adjunto (Cliente)</button>
        </div>
        <div class="mt-8 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
            <button id="exportClientPDFBtn" class="btn-primary w-full sm:w-auto" data-client-id="">Exportar Ficha a PDF</button>
            <div class="flex space-x-3">
                <button id="editClientModalBtn" class="btn-secondary" data-client-id="">Editar</button>
                <button id="deleteClientModalBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md font-medium" data-client-id="">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<div id="propertyDetailsModal" class="modal">
    <div class="modal-content">
        <span class="close-modal-btn" onclick="closeModal('propertyDetailsModal')">×</span>
        <h2 class="text-xl font-bold mb-4">Detalles de Propiedad: <span id="modalPropertyAddress"></span></h2>
        <img id="modalPropertyImage" src="#" alt="Imagen de la propiedad" class="modal-property-image hidden mb-6"/>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
            <div><strong class="text-gray-600">Precio:</strong> <span id="modalPropertyPrice">-</span></div>
            <div><strong class="text-gray-600">Vendedor/Agencia:</strong> <span id="modalSellerName">-</span></div>
            <div><strong class="text-gray-600">Teléfono Vendedor:</strong> <span id="modalSellerPhone">-</span></div>
            <div><strong class="text-gray-600">Origen:</strong> <span id="modalSellerType">-</span></div>
            <div><strong class="text-gray-600">Planta:</strong> <span id="modalPropertyFloor">-</span></div>
            <div><strong class="text-gray-600">Metros Cuadrados:</strong> <span id="modalPropertySqMeters">-</span> m²</div>
            <div><strong class="text-gray-600">Habitaciones:</strong> <span id="modalPropertyRooms">-</span></div>
            <div><strong class="text-gray-600">Baños:</strong> <span id="modalPropertyBaths">-</span></div>
            <div><strong class="text-gray-600">Ascensor:</strong> <span id="modalPropertyElevator">-</span></div>
            <div class="md:col-span-2"><strong class="text-gray-600">URL Anuncio:</strong> <span id="modalPropertyURL" class="break-all">-</span></div>
        </div>
         <div class="mt-6">
            <h3 class="text-lg font-semibold mb-2">Comentarios (Propiedad)</h3>
            <div id="modalPropertyComments" class="p-3 bg-gray-50 rounded-md text-gray-700 min-h-[80px] whitespace-pre-wrap">-</div>
        </div>
        <div class="mt-8 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
            <div class="flex flex-wrap gap-3">
                <button id="exportPropertyPDFBtn" class="btn-primary" data-property-id="">Exportar Ficha</button>
                <button id="viewPropertyOnlineBtn" class="btn-link" data-property-id="" disabled>
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.586 2.586a2 2 0 00-2.828 0L8.343 3.999a2 2 0 102.828 2.829L12.586 5.414a2 2 0 000-2.828zM7.414 12.586a2 2 0 002.828 0L11.657 11.17a2 2 0 10-2.828-2.828L7.414 9.757a2 2 0 000 2.829zm2.172-6.757a3.5 3.5 0 010 4.95l-2.5 2.5a3.5 3.5 0 11-4.95-4.95l2.5-2.5a3.5 3.5 0 014.95 0zm6.757 2.172a3.5 3.5 0 010 4.95l-2.5 2.5a3.5 3.5 0 01-4.95-4.95l.707-.707a1.5 1.5 0 012.121 2.121l-.707.707a1.5 1.5 0 002.121 2.121l2.5-2.5a1.5 1.5 0 00-2.121-2.121l-.707.707a3.501 3.501 0 01-3.535-1.414A3.485 3.485 0 015.828 7.5H5a1 1 0 110-2h.828a3.5 3.5 0 014.95 0z" clip-rule="evenodd" />
                    </svg>
                    Ver Anuncio
                </button>
            </div>
            <div class="flex space-x-3">
                <button id="editPropertyModalBtn" class="btn-secondary" data-property-id="">Editar</button>
                <button id="deletePropertyModalBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md font-medium" data-property-id="">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<div id="collaboratorDetailsModal" class="modal">
    <div class="modal-content">
        <span class="close-modal-btn" onclick="closeModal('collaboratorDetailsModal')">×</span>
        <h2 class="text-xl font-bold mb-6">Detalles de <span id="modalCollaboratorName">Colaborador</span></h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
            <div><strong class="text-gray-600">Nombre Agencia:</strong> <span id="modalCollaboratorAgencyName">-</span></div>
            <div><strong class="text-gray-600">Teléfono:</strong> <span id="modalCollaboratorPhone">-</span></div>
            <div><strong class="text-gray-600">Email:</strong> <span id="modalCollaboratorEmail">-</span></div>
            <div class="md:col-span-2"><strong class="text-gray-600">Dirección:</strong> <span id="modalCollaboratorAddress">-</span></div>
            <div class="md:col-span-2"><strong class="text-gray-600">URL:</strong> <span id="modalCollaboratorURL" class="break-all">-</span></div>
        </div>
        <div class="mt-6">
            <h3 class="text-lg font-semibold mb-2">Comentarios</h3>
            <div id="modalCollaboratorComments" class="p-3 bg-gray-50 rounded-md text-gray-700 min-h-[80px] whitespace-pre-wrap">-</div>
        </div>
        <div id="modalCollaboratorPdfSection" class="mt-4 hidden">
            <button id="modalCollaboratorViewPdfBtn" class="btn-secondary text-sm" data-collaborator-id="">Ver PDF Adjunto (Colaborador)</button>
        </div>
        <div class="mt-8 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
            <button id="exportCollaboratorPDFBtn" class="btn-primary w-full sm:w-auto" data-collaborator-id="">Exportar Ficha a PDF</button>
            <div class="flex space-x-3">
                <button id="editCollaboratorModalBtn" class="btn-secondary" data-collaborator-id="">Editar</button>
                <button id="deleteCollaboratorModalBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md font-medium" data-collaborator-id="">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<div id="privateSellerDetailsModal" class="modal">
    <div class="modal-content">
        <span class="close-modal-btn" onclick="closeModal('privateSellerDetailsModal')">×</span>
        <h2 class="text-xl font-bold mb-4">Detalles Vendedor Particular: <span id="modalPrivateSellerOwnerName"></span></h2>
        <img id="modalPrivateSellerPropertyImage" src="#" alt="Imagen del inmueble" class="modal-property-image hidden mb-6"/>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
            <div><strong class="text-gray-600">Teléfono:</strong> <span id="modalPrivateSellerOwnerPhone">-</span></div>
            <div><strong class="text-gray-600">Email:</strong> <span id="modalPrivateSellerOwnerEmail">-</span></div>
            <div class="md:col-span-2"><strong class="text-gray-600">Dirección Inmueble:</strong> <span id="modalPrivateSellerPropertyAddress">-</span></div>
            <div><strong class="text-gray-600">Zona Inmueble:</strong> <span id="modalPrivateSellerPropertyZone">-</span></div>
            <div><strong class="text-gray-600">Planta:</strong> <span id="modalPrivateSellerPropertyFloor">-</span></div>
            <div><strong class="text-gray-600">Habitaciones:</strong> <span id="modalPrivateSellerPropertyRooms">-</span></div>
            <div><strong class="text-gray-600">Metros Cuadrados:</strong> <span id="modalPrivateSellerPropertySqMeters">-</span> m²</div>
            <div><strong class="text-gray-600">Ascensor:</strong> <span id="modalPrivateSellerPropertyElevator">-</span></div>
            <div><strong class="text-gray-600">Estado Seguimiento:</strong> <span id="modalPrivateSellerStatus">-</span></div>
            <div class="md:col-span-2"><strong class="text-gray-600">URL Anuncio:</strong> <span id="modalPrivateSellerPropertyURL" class="break-all">-</span></div>
        </div>
         <div class="mt-6">
            <h3 class="text-lg font-semibold mb-2">Comentarios (Seguimiento)</h3>
            <div id="modalPrivateSellerComments" class="p-3 bg-gray-50 rounded-md text-gray-700 min-h-[80px] whitespace-pre-wrap">-</div>
        </div>
        <div class="mt-8 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
             <div class="flex flex-wrap gap-3">
                <button id="exportPrivateSellerPDFBtn" class="btn-primary" data-privateseller-id="">Exportar Ficha</button>
                 <button id="viewPrivateSellerPropertyOnlineBtn" class="btn-link" data-privateseller-id="" disabled>
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.586 2.586a2 2 0 00-2.828 0L8.343 3.999a2 2 0 102.828 2.829L12.586 5.414a2 2 0 000-2.828zM7.414 12.586a2 2 0 002.828 0L11.657 11.17a2 2 0 10-2.828-2.828L7.414 9.757a2 2 0 000 2.829zm2.172-6.757a3.5 3.5 0 010 4.95l-2.5 2.5a3.5 3.5 0 11-4.95-4.95l2.5-2.5a3.5 3.5 0 014.95 0zm6.757 2.172a3.5 3.5 0 010 4.95l-2.5 2.5a3.5 3.5 0 01-4.95-4.95l.707-.707a1.5 1.5 0 012.121 2.121l-.707.707a1.5 1.5 0 002.121 2.121l2.5-2.5a1.5 1.5 0 00-2.121-2.121l-.707.707a3.501 3.501 0 01-3.535-1.414A3.485 3.485 0 015.828 7.5H5a1 1 0 110-2h.828a3.5 3.5 0 014.95 0z" clip-rule="evenodd" />
                    </svg>
                    Ver Anuncio
                </button>
                <button id="scheduleGCalPrivateSellerBtn" class="btn-secondary" data-privateseller-id="">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                    </svg>
                    Agendar GCal
                </button>
            </div>
            <div class="flex space-x-3">
                <button id="editPrivateSellerModalBtn" class="btn-secondary" data-privateseller-id="">Editar</button>
                <button id="deletePrivateSellerModalBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md font-medium" data-privateseller-id="">Eliminar</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal para Imagen Ampliada -->
<div id="imageZoomModal" class="modal">
    <div class="modal-content" style="background-color: transparent; box-shadow: none; display: flex; align-items: center; justify-content: center; padding: 1rem;">
        <span class="close-modal-btn" onclick="closeModal('imageZoomModal')" style="position: absolute; top: 10px; right: 20px; font-size: 40px; color: white; text-shadow: 0 0 5px black;">&times;</span>
        <img id="zoomedImage" src="#" alt="Imagen Ampliada" style="max-width: 95vw; max-height: 95vh; object-fit: contain; border-radius: 0.5rem; box-shadow: 0 0 25px rgba(0,0,0,0.5);">
    </div>
</div>


<footer class="bg-white border-t border-gray-200 mt-12">
    <div class="container mx-auto px-4 py-6 text-center text-gray-500 text-sm">
        <p>© <span id="currentYear"></span> MERCAT IMMOBILIARI</p>
    </div>
</footer>

<script>
    // Buyer Clients
    let clients = [];
    let currentEditingClientId = null;
    
    // Properties (Sellers - Captadas/Colaboradores)
    let properties = [];
    let currentEditingPropertyId = null;

    // NEW: Private Sellers (for tracking)
    let privateSellers = [];
    let currentEditingPrivateSellerId = null;

    // Collaborators
    let collaborators = [];
    let currentEditingCollaboratorId = null;

    let darkMode = true; 

    const AGENT_INFO = {
        name: "Daniel Hernández",
        title: "Agente experto",
        phone: "620809938",
        email: "daniel.mic2022@gmail.com",
        companyName: "MERCAT IMMOBILIARI"
    };
    
    const XLSX_HEADERS_CLIENTS = [
        "ID Cliente", "Nombre Completo", "Teléfono", "Email", "Precio Máximo (€)", "Aportación (€)", 
        "Zona(s) de Interés", "Hipoteca Aprobada", "Estado Cliente", "Nº Habitaciones Deseadas", 
        "Ascensor Preferencia", "Metros Mínimos (m²)", "Metros Máximos (m²)", "Comentarios Adicionales Cliente", "Nombre PDF Adjunto Cliente"
    ];
    const XLSX_HEADERS_PROPERTIES = [ 
        "ID Propiedad", "Dirección/Referencia", "Precio Venta (€)", 
        "Nombre Vendedor/Agencia", "Teléfono Vendedor", "Tipo Vendedor/Origen", "Planta Inmueble",
        "Metros Cuadrados (m²)", "Nº Habitaciones", "Nº Baños", "Ascensor Propiedad", "URL Anuncio", 
        "Comentarios Propiedad", "Nombre Imagen Propiedad"
    ];
    const XLSX_HEADERS_COLLABORATORS = [
        "ID Colaborador", "Nombre Colaborador", "Nombre Agencia", "Teléfono", "Email", "Dirección", "URL", "Comentarios", "Nombre PDF Adjunto"
    ];
    const XLSX_HEADERS_PRIVATE_SELLERS = [
        "ID Particular Seguimiento", "Nombre Propietario", "Teléfono Propietario", "Email Propietario",
        "Dirección Inmueble", "Zona Inmueble", "Planta Inmueble",
        "Nº Habitaciones", "Metros Cuadrados (m²)", "Ascensor Inmueble",
        "URL Anuncio", "Estado Seguimiento", "Comentarios Seguimiento", "Nombre Imagen Inmueble"
    ];


    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        const storedDarkMode = localStorage.getItem('mercatImmoDarkMode'); // Updated key
        if (storedDarkMode === 'false') { 
            darkMode = false;
        } else if (storedDarkMode === 'true') {
            darkMode = true;
        } 
        applyDarkMode(); 

        initTabs();
        
        loadClients();
        loadProperties();
        loadCollaborators();
        loadPrivateSellers(); // Load new data
        
        updateClientsTable();
        updatePropertiesTable();
        updateCollaboratorsTable();
        updatePrivateSellersTable(); // Update new table

        document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
        
        // Client Listeners
        document.getElementById('saveClientBtn').addEventListener('click', saveClient);
        document.getElementById('newClientBtn').addEventListener('click', prepareNewClientForm);
        document.getElementById('filterStatus').addEventListener('change', updateClientsTable);
        document.getElementById('filterZone').addEventListener('input', updateClientsTable);
        document.getElementById('filterPriceMin').addEventListener('input', updateClientsTable);
        document.getElementById('filterPriceMax').addEventListener('input', updateClientsTable);
        document.getElementById('filterNumRooms').addEventListener('change', updateClientsTable);
        document.getElementById('filterElevator').addEventListener('change', updateClientsTable);
        document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);

        // Property (Captada/Colaborador) Listeners
        document.getElementById('savePropertyBtn').addEventListener('click', saveProperty);
        document.getElementById('newPropertyBtn').addEventListener('click', prepareNewPropertyForm);
        document.getElementById('propertyImageFile').addEventListener('change', (e) => previewImage(e, 'propertyImagePreview'));


        // Private Seller Listeners (NEW)
        document.getElementById('savePrivateSellerBtn').addEventListener('click', savePrivateSeller);
        document.getElementById('newPrivateSellerBtn').addEventListener('click', prepareNewPrivateSellerForm);
        document.getElementById('privateSellerPropertyImageFile').addEventListener('change', (e) => previewImage(e, 'privateSellerPropertyImagePreview'));
        document.getElementById('filterPrivateSellerStatus').addEventListener('change', updatePrivateSellersTable);
        document.getElementById('filterPrivateSellerZone').addEventListener('input', updatePrivateSellersTable);
        document.getElementById('resetPrivateSellerFiltersBtn').addEventListener('click', resetPrivateSellerFilters);


        // Collaborator Listeners
        document.getElementById('saveCollaboratorBtn').addEventListener('click', saveCollaborator);
        document.getElementById('newCollaboratorBtn').addEventListener('click', prepareNewCollaboratorForm);

        document.getElementById('performCruceBtn').addEventListener('click', performCrossReferencing);

        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target.id);
            }
        });

        // Client Modal Buttons
        document.getElementById('exportClientPDFBtn').addEventListener('click', function() {
            exportClientDetailsToPDF(this.getAttribute('data-client-id'));
        });
        document.getElementById('editClientModalBtn').addEventListener('click', function() {
            editClient(this.getAttribute('data-client-id'));
            closeModal('clientDetailsModal');
        });
        document.getElementById('deleteClientModalBtn').addEventListener('click', function() {
            deleteClient(this.getAttribute('data-client-id')); 
        });
        document.getElementById('modalClientViewPdfBtn').addEventListener('click', function() {
            handleViewPDF(this.getAttribute('data-client-id'), 'client');
        });
        
        // Property Modal Buttons
        document.getElementById('exportPropertyPDFBtn').addEventListener('click', function() {
            exportPropertyDetailsToPDF(this.getAttribute('data-property-id'));
        });
         document.getElementById('viewPropertyOnlineBtn').addEventListener('click', function() {
            const propertyId = this.getAttribute('data-property-id');
            const prop = properties.find(p => p.id === propertyId);
            if (prop && prop.propertyURL) {
                let url = prop.propertyURL;
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                window.open(url, '_blank');
            }
        });
        document.getElementById('editPropertyModalBtn').addEventListener('click', function() {
            editProperty(this.getAttribute('data-property-id'));
            closeModal('propertyDetailsModal');
        });
        document.getElementById('deletePropertyModalBtn').addEventListener('click', function() {
            deleteProperty(this.getAttribute('data-property-id')); 
        });

        // Collaborator Modal Buttons
        document.getElementById('exportCollaboratorPDFBtn').addEventListener('click', function() {
            exportCollaboratorDetailsToPDF(this.getAttribute('data-collaborator-id'));
        });
        document.getElementById('editCollaboratorModalBtn').addEventListener('click', function() {
            editCollaborator(this.getAttribute('data-collaborator-id'));
            closeModal('collaboratorDetailsModal');
        });
        document.getElementById('deleteCollaboratorModalBtn').addEventListener('click', function() {
            deleteCollaborator(this.getAttribute('data-collaborator-id'));
        });
         document.getElementById('modalCollaboratorViewPdfBtn').addEventListener('click', function() {
            handleViewPDF(this.getAttribute('data-collaborator-id'), 'collaborator');
        });

        // Private Seller Modal Buttons (NEW)
        document.getElementById('exportPrivateSellerPDFBtn').addEventListener('click', function() {
            exportPrivateSellerDetailsToPDF(this.getAttribute('data-privateseller-id'));
        });
        document.getElementById('editPrivateSellerModalBtn').addEventListener('click', function() {
            editPrivateSeller(this.getAttribute('data-privateseller-id'));
            closeModal('privateSellerDetailsModal');
        });
        document.getElementById('deletePrivateSellerModalBtn').addEventListener('click', function() {
            deletePrivateSeller(this.getAttribute('data-privateseller-id'));
        });
        document.getElementById('viewPrivateSellerPropertyOnlineBtn').addEventListener('click', function() {
            const privateSellerId = this.getAttribute('data-privateseller-id');
            const ps = privateSellers.find(p => p.id === privateSellerId);
            if (ps && ps.propertyURL) {
                let url = ps.propertyURL;
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                window.open(url, '_blank');
            }
        });
        // Google Calendar button in Modal
        document.getElementById('scheduleGCalPrivateSellerBtn').addEventListener('click', function() {
            generateGoogleCalendarLink(this.getAttribute('data-privateseller-id'));
        });


        // Config Tab Buttons
        document.getElementById('exportJsonBtn').addEventListener('click', exportDBtoJSON);
        document.getElementById('importJsonTriggerBtn').addEventListener('click', () => document.getElementById('importJsonInput').click());
        document.getElementById('importJsonInput').addEventListener('change', handleJSONImport);
        
        document.getElementById('exportXlsxBtn').addEventListener('click', exportDBtoXLSX);
        document.getElementById('importXlsxTriggerBtn').addEventListener('click', () => document.getElementById('importXlsxInput').click());
        document.getElementById('importXlsxInput').addEventListener('change', handleXLSXImport);

        prepareNewClientForm(); 
        prepareNewPropertyForm();
        prepareNewCollaboratorForm();
        prepareNewPrivateSellerForm(); // Init new form
    });

    function applyDarkMode() {
        const toggleButton = document.getElementById('darkModeToggle');
        if (darkMode) {
            document.body.classList.add('dark');
            document.documentElement.classList.add('dark'); // For scrollbar styling if needed
            toggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd" /></svg>`;
        } else {
            document.body.classList.remove('dark');
            document.documentElement.classList.remove('dark');
            toggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" /></svg>`;
        }
    }
    function toggleDarkMode() {
        darkMode = !darkMode;
        localStorage.setItem('mercatImmoDarkMode', darkMode); // Updated key
        applyDarkMode();
        updateClientsTable(); 
        updatePropertiesTable();
        updateCollaboratorsTable();
        updatePrivateSellersTable(); // Update new table
    }

    function initTabs() {
        const tabs = document.querySelectorAll('.tab-btn');
        const defaultTab = 'compradores'; 
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('text-blue-600', 'border-blue-600', 'font-semibold'));
                tab.classList.add('text-blue-600', 'border-blue-600', 'font-semibold');
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`${tab.dataset.tab}Tab`).classList.add('active');
            });
        });
        const activeTabButton = document.querySelector(`.tab-btn[data-tab="${defaultTab}"]`);
        if (activeTabButton) activeTabButton.click();
        else if (tabs.length > 0) tabs[0].click();
    }


    function prepareNewClientForm() {
        document.getElementById('formTitle').textContent = 'Añadir Nuevo Cliente Comprador';
        document.getElementById('buyerClientForm').reset();
        document.getElementById('clientStatusForm').value = 'seguimiento'; 
        document.getElementById('clientElevator').value = 'indiferente';
        document.getElementById('clientNumRooms').value = '';
        currentEditingClientId = null;
        document.getElementById('clientName').focus();
    }

    function saveClient() {
        const clientData = {
            id: currentEditingClientId || Date.now().toString() + Math.random().toString(16).slice(2),
            name: document.getElementById('clientName').value.trim(),
            phone: document.getElementById('clientPhone').value.trim(),
            email: document.getElementById('clientEmail').value.trim(),
            priceMax: parseFloat(document.getElementById('clientPriceMax').value) || 0,
            zone: document.getElementById('clientZone').value.trim(),
            mortgageApproved: document.getElementById('mortgageApproved').value,
            contribution: parseFloat(document.getElementById('clientContribution').value) || 0,
            status: document.getElementById('clientStatusForm').value,
            comments: document.getElementById('clientComments').value.trim(),
            numRooms: document.getElementById('clientNumRooms').value.trim() || null, 
            elevator: document.getElementById('clientElevator').value,
            minSqMeters: document.getElementById('clientMinSqMeters').value ? parseInt(document.getElementById('clientMinSqMeters').value) : null,
            maxSqMeters: document.getElementById('clientMaxSqMeters').value ? parseInt(document.getElementById('clientMaxSqMeters').value) : null,
            pdfData: null, 
            pdfName: null
        };

        if (!clientData.name) {
            alert(`El nombre del cliente es obligatorio. (${AGENT_INFO.companyName})`);
            return;
        }

        if (currentEditingClientId) {
            const index = clients.findIndex(c => c.id === currentEditingClientId);
            if (index !== -1) {
                clientData.pdfData = clients[index].pdfData; 
                clientData.pdfName = clients[index].pdfName;
                clients[index] = clientData;
            }
        } else {
            clients.push(clientData);
        }
        
        saveClientsToLocalStorage();
        updateClientsTable();
        prepareNewClientForm(); 
        alert(`Cliente "${clientData.name}" ${currentEditingClientId ? 'actualizado' : 'guardado'} correctamente. (${AGENT_INFO.companyName})`);
    }

    function editClient(clientId) {
        const client = clients.find(c => c.id === clientId);
        if (client) {
            document.getElementById('formTitle').textContent = `Editando Cliente: ${client.name}`;
            document.getElementById('clientId').value = client.id; 
            document.getElementById('clientName').value = client.name;
            document.getElementById('clientPhone').value = client.phone;
            document.getElementById('clientEmail').value = client.email;
            document.getElementById('clientPriceMax').value = client.priceMax;
            document.getElementById('clientZone').value = client.zone;
            document.getElementById('mortgageApproved').value = client.mortgageApproved;
            document.getElementById('clientContribution').value = client.contribution;
            document.getElementById('clientStatusForm').value = client.status;
            document.getElementById('clientComments').value = client.comments;
            document.getElementById('clientNumRooms').value = client.numRooms || '';
            document.getElementById('clientElevator').value = client.elevator || 'indiferente';
            document.getElementById('clientMinSqMeters').value = client.minSqMeters !== null ? client.minSqMeters : '';
            document.getElementById('clientMaxSqMeters').value = client.maxSqMeters !== null ? client.maxSqMeters : '';
            currentEditingClientId = client.id;
            
            const formTabButton = document.querySelector('.tab-btn[data-tab="compradores"]');
            if(formTabButton) formTabButton.click();
            
            document.getElementById('clientName').focus();
            document.getElementById('buyerClientForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    function deleteClient(clientId) {
        const clientIndex = clients.findIndex(c => c.id === clientId);
        if (clientIndex !== -1) {
            if (confirm(`¿Está seguro de que desea eliminar al cliente "${clients[clientIndex].name}"? (${AGENT_INFO.companyName})`)) {
                clients.splice(clientIndex, 1);
                saveClientsToLocalStorage();
                updateClientsTable();
                if (currentEditingClientId === clientId) { 
                    prepareNewClientForm();
                }
                alert(`Cliente eliminado. (${AGENT_INFO.companyName})`);
                closeModal('clientDetailsModal'); 
            }
        }
    }
    
    function formatCurrency(value) {
        const numValue = parseFloat(value);
        if (isNaN(numValue) || (numValue === 0 && (value !== 0 && value !== '0' && value !== null && value !== undefined)) ) return '-';
        if (numValue === 0 && (value === 0 || value === '0')) return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0 }).format(0);
        return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0 }).format(numValue);
    }

    function getStatusText(statusKey, type = 'general') { 
        const mortgageMap = { 'si': 'Sí', 'no': 'No', 'en_proceso': 'En Proceso', 'no_necesita': 'No Necesita' };
        const clientStatusMap = { 'activo': 'Activo', 'no_activo': 'No Activo', 'seguimiento': 'Seguimiento', 'descartado': 'Descartado' };
        const elevatorMap = { // Client preference view
            'si': 'Sí, es indispensable', 
            'no': 'No es indispensable (OK sin él)', 
            'indiferente': 'Indiferente / No especificado', 
            'no_indispensable_1': 'No indisp. hasta 1º',
            'no_indispensable_2': 'No indisp. hasta 2º',
            'no_indispensable_3': 'No indisp. hasta 3º',
            'no_indispensable_4': 'No indisp. hasta 4º'
        };
        const propertyElevatorMap = { 'si': 'Sí Tiene', 'no': 'No Tiene', 'indiferente': 'Indiferente / No consta'};
        const sellerTypeMap = {'particular': 'Particular (Captación propia)', 'agencia': 'Agencia (Colaborador)'};
        const privateSellerStatusMap = {
            'seguimiento': 'Seguimiento',
            'activo': 'Contactado (Interesado)',
            'no_activo': 'Contactado (No Interesado)',
            'descartado': 'Descartado / Vendido por otro'
        };
        
        let mapToUse;
        if (type === 'mortgage') mapToUse = mortgageMap;
        else if (type === 'clientStatus') mapToUse = clientStatusMap;
        else if (type === 'elevator') mapToUse = elevatorMap; 
        else if (type === 'propertyElevator') mapToUse = propertyElevatorMap;
        else if (type === 'sellerType') mapToUse = sellerTypeMap;
        else if (type === 'privateSellerStatus') mapToUse = privateSellerStatusMap;
        else mapToUse = {};

        return mapToUse[statusKey] || (statusKey ? String(statusKey).charAt(0).toUpperCase() + String(statusKey).slice(1).replace(/_/g, ' ') : '-');
    }
    
    function getStatusColorClass(status, type = 'client') { // Added type for privateSeller differentiation if needed
        const isDark = document.body.classList.contains('dark');
        // For now, client and privateSeller use similar color logic. Can be differentiated if needed.
        switch (status) {
            case 'activo': return isDark ? 'bg-green-600 text-green-100' : 'bg-green-100 text-green-700';
            case 'no_activo': return isDark ? 'bg-red-600 text-red-100' : 'bg-red-100 text-red-700';
            case 'seguimiento': return isDark ? 'bg-yellow-500 text-yellow-100' : 'bg-yellow-100 text-yellow-700';
            case 'descartado': return isDark ? 'bg-gray-500 text-gray-200' : 'bg-gray-200 text-gray-700';
            default: return isDark ? 'bg-gray-400 text-gray-100' : 'bg-gray-100 text-gray-600';
        }
    }

    function updateClientsTable() {
        const tbody = document.querySelector('#clientsTable tbody');
        const noDataMsg = document.getElementById('noDataMessage');
        if (!tbody || !noDataMsg) return;
        tbody.innerHTML = '';

        const statusFilter = document.getElementById('filterStatus').value;
        const zoneFilter = document.getElementById('filterZone').value.toLowerCase();
        const priceMinFilter = parseFloat(document.getElementById('filterPriceMin').value) || 0;
        const priceMaxFilter = parseFloat(document.getElementById('filterPriceMax').value) || Infinity;
        const numRoomsFilter = document.getElementById('filterNumRooms').value;
        const elevatorFilter = document.getElementById('filterElevator').value;

        const filteredClients = clients.filter(client => {
            const statusMatch = statusFilter === 'todos' || client.status === statusFilter;
            const zoneMatch = !zoneFilter || (client.zone && client.zone.toLowerCase().includes(zoneFilter));
            const priceMatch = (client.priceMax >= priceMinFilter) && (client.priceMax <= priceMaxFilter);
            
            let clientRoomsText = String(client.numRooms || '').toLowerCase();
            let numRoomsMatch = numRoomsFilter === 'todos';
            if (!numRoomsMatch && client.numRooms !== null) {
                if (numRoomsFilter === '5') { 
                    const firstNum = parseInt(clientRoomsText.match(/\d+/)?.[0]); 
                    if (!isNaN(firstNum) && firstNum >= 5) numRoomsMatch = true;
                } else if (numRoomsFilter === '0' && (clientRoomsText === '0' || clientRoomsText.includes('estudio'))) {
                     numRoomsMatch = true;
                } else if (clientRoomsText.includes(numRoomsFilter) || clientRoomsText.split(/\s*o\s*|\s*-\s*|\s*,\s*/).includes(numRoomsFilter)){ 
                    numRoomsMatch = true;
                }
            }
            
            let elevatorMatch = elevatorFilter === 'todos' || client.elevator === elevatorFilter;
             if (elevatorFilter === 'no' && (client.elevator === 'no' || (client.elevator && client.elevator.startsWith('no_indispensable')))) {
                elevatorMatch = true; 
             }
            return statusMatch && zoneMatch && priceMatch && numRoomsMatch && elevatorMatch;
        });

        if (filteredClients.length === 0) {
            noDataMsg.style.display = 'block';
        } else {
            noDataMsg.style.display = 'none';
            filteredClients.forEach(client => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${client.name}</td>
                    <td>${client.phone || '-'}</td>
                    <td>${client.email || '-'}</td>
                    <td>${formatCurrency(client.priceMax)}</td>
                    <td>${formatCurrency(client.contribution)}</td>
                    <td>${client.zone || '-'}</td>
                    <td>${getStatusText(client.mortgageApproved, 'mortgage')}</td>
                    <td><span class="px-2 py-1 rounded-full text-xs font-semibold ${getStatusColorClass(client.status)}">${getStatusText(client.status, 'clientStatus')}</span></td>
                    <td>${client.numRooms || '-'}</td>
                    <td>${getStatusText(client.elevator, 'elevator')}</td>
                    <td>${client.minSqMeters !== null ? client.minSqMeters + ' m²' : '-'}</td>
                    <td>${client.maxSqMeters !== null ? client.maxSqMeters + ' m²' : '-'}</td>
                    <td>
                        <button data-action="attach-pdf" data-type="client" data-id="${client.id}" class="text-green-500 hover:text-green-700 dark:text-green-400 dark:hover:text-green-300 p-1" title="Adjuntar PDF (Cliente)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6 10a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 4a1 1 0 100 2h4a1 1 0 100-2H7zM3 3a1 1 0 000 2h14a1 1 0 100-2H3zm2 4a1 1 0 011-1h2a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                        ${client.pdfData ? `
                        <button data-action="view-pdf" data-type="client" data-id="${client.id}" class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 ml-1 p-1" title="Ver ${client.pdfName || 'PDF Cliente'}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                        </button>` : ''}
                    </td>
                    <td>
                        <div class="flex space-x-1">
                            <button data-action="view" data-id="${client.id}" data-type="client" class="text-blue-600 hover:text-blue-800 p-1" title="Ver Detalles"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></button>
                            <button data-action="edit" data-id="${client.id}" data-type="client" class="text-yellow-600 hover:text-yellow-800 p-1" title="Editar Cliente"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                            <button data-action="delete" data-id="${client.id}" data-type="client" class="text-red-600 hover:text-red-800 p-1" title="Eliminar Cliente"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div>
                    </td>
                `;
            });
        }
        addTableActionListeners('clientsTable', 'client');
    }
    
    function addTableActionListeners(tableId, defaultItemType) { 
        document.querySelectorAll(`#${tableId} [data-action]`).forEach(button => {
            const newButton = button.cloneNode(true); 
            button.parentNode.replaceChild(newButton, button);

            newButton.addEventListener('click', function() {
                const action = this.dataset.action;
                const id = this.dataset.id;
                const type = this.dataset.type || defaultItemType; 

                if (type === 'client') {
                    if (action === 'view') showClientDetailsModal(id);
                    else if (action === 'edit') editClient(id);
                    else if (action === 'delete') deleteClient(id);
                    else if (action === 'attach-pdf') handleAttachPDF(id, 'client');
                    else if (action === 'view-pdf') handleViewPDF(id, 'client');
                } else if (type === 'property') {
                    if (action === 'view') showPropertyDetailsModal(id);
                    else if (action === 'edit') editProperty(id);
                    else if (action === 'delete') deleteProperty(id);
                } else if (type === 'collaborator') {
                    if (action === 'view') showCollaboratorDetailsModal(id);
                    else if (action === 'edit') editCollaborator(id);
                    else if (action === 'delete') deleteCollaborator(id);
                    else if (action === 'attach-pdf') handleAttachPDF(id, 'collaborator');
                    else if (action === 'view-pdf') handleViewPDF(id, 'collaborator');
                } else if (type === 'privateSeller') {
                    if (action === 'view') showPrivateSellerDetailsModal(id);
                    else if (action === 'edit') editPrivateSeller(id);
                    else if (action === 'delete') deletePrivateSeller(id);
                    else if (action === 'whatsapp') sendWhatsAppToPrivateSeller(id);
                    else if (action === 'schedule-gcal') generateGoogleCalendarLink(id); // NEW
                }
            });
        });
    }

    function resetFilters() {
        document.getElementById('filterStatus').value = 'todos';
        document.getElementById('filterZone').value = '';
        document.getElementById('filterPriceMin').value = '';
        document.getElementById('filterPriceMax').value = '';
        document.getElementById('filterNumRooms').value = 'todos';
        document.getElementById('filterElevator').value = 'todos';
        updateClientsTable();
    }

    function showClientDetailsModal(clientId) {
        const client = clients.find(c => c.id === clientId);
        if (client) {
            document.getElementById('modalClientName').textContent = client.name;
            document.getElementById('modalClientPhone').textContent = client.phone || '-';
            document.getElementById('modalClientEmail').textContent = client.email || '-';
            document.getElementById('modalClientPriceMax').textContent = formatCurrency(client.priceMax);
            document.getElementById('modalClientContribution').textContent = formatCurrency(client.contribution);
            document.getElementById('modalClientZone').textContent = client.zone || '-';
            document.getElementById('modalMortgageApproved').textContent = getStatusText(client.mortgageApproved, 'mortgage');
            document.getElementById('modalClientStatus').textContent = getStatusText(client.status, 'clientStatus');
            document.getElementById('modalClientComments').textContent = client.comments || '-';
            document.getElementById('modalClientNumRooms').textContent = client.numRooms || '-';
            document.getElementById('modalClientElevator').textContent = getStatusText(client.elevator, 'elevator');
            document.getElementById('modalClientMinSqMeters').textContent = client.minSqMeters !== null ? client.minSqMeters : '-';
            document.getElementById('modalClientMinSqMetersUnit').textContent = client.minSqMeters !== null ? ' m²' : '';
            document.getElementById('modalClientMaxSqMeters').textContent = client.maxSqMeters !== null ? client.maxSqMeters : '-';
            document.getElementById('modalClientMaxSqMetersUnit').textContent = client.maxSqMeters !== null ? ' m²' : '';

            document.getElementById('exportClientPDFBtn').setAttribute('data-client-id', client.id);
            document.getElementById('editClientModalBtn').setAttribute('data-client-id', client.id);
            document.getElementById('deleteClientModalBtn').setAttribute('data-client-id', client.id);
            
            const modalPdfSection = document.getElementById('modalClientPdfSection');
            const modalViewPdfBtn = document.getElementById('modalClientViewPdfBtn');
            if (client.pdfData) {
                modalViewPdfBtn.setAttribute('data-client-id', client.id);
                modalViewPdfBtn.textContent = `Ver ${client.pdfName || 'PDF Adjunto (Cliente)'}`;
                modalPdfSection.classList.remove('hidden');
            } else {
                modalPdfSection.classList.add('hidden');
            }
            document.getElementById('clientDetailsModal').style.display = 'block';
        }
    }
    
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
        }
    }

    function handleAttachPDF(itemId, itemType) { 
        const itemArray = itemType === 'client' ? clients : (itemType === 'collaborator' ? collaborators : []);
        // Note: PDF attachment for privateSellers is not implemented in this iteration for brevity, but could be added.
        const item = itemArray.find(i => i.id === itemId);
        if (!item) return;

        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.pdf';
        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { 
                    alert(`El archivo es demasiado grande. El límite es 5MB. (${AGENT_INFO.companyName})`);
                    return;
                }
                const reader = new FileReader();
                reader.onload = (event) => {
                    item.pdfData = event.target.result; 
                    item.pdfName = file.name;
                    
                    let itemNameForAlert = '';
                    if (itemType === 'client') {
                        saveClientsToLocalStorage();
                        updateClientsTable(); 
                        itemNameForAlert = item.name;
                    } else if (itemType === 'collaborator') {
                        saveCollaboratorsToLocalStorage();
                        updateCollaboratorsTable();
                        itemNameForAlert = item.collaboratorName;
                    }
                    alert(`PDF "${file.name}" adjuntado para ${itemNameForAlert}. (${AGENT_INFO.companyName})`);
                };
                reader.onerror = () => { alert(`Error al leer el archivo. (${AGENT_INFO.companyName})`); };
                reader.readAsDataURL(file);
            }
        };
        fileInput.click();
    }

    function handleViewPDF(itemId, itemType) {
        const itemArray = itemType === 'client' ? clients : (itemType === 'collaborator' ? collaborators : []);
        const item = itemArray.find(i => i.id === itemId);
        
        let itemTypeName = itemType === 'client' ? 'cliente' : (itemType === 'collaborator' ? 'colaborador' : 'elemento');

        if (!item || !item.pdfData) {
            alert(`No hay PDF adjunto para este ${itemTypeName}. (${AGENT_INFO.companyName})`);
            return;
        }
        try {
            const newTab = window.open();
            if (newTab) {
                newTab.document.write(`<iframe width='100%' height='100%' src='${item.pdfData}' title='${item.pdfName || "Documento PDF"}'></iframe>`);
                newTab.document.title = item.pdfName || "Documento PDF";
            } else {
                 alert(`No se pudo abrir el PDF. Revisa si tu navegador bloqueó la ventana emergente. (${AGENT_INFO.companyName})`);
            }
        } catch (error) {
             alert(`Error al intentar abrir el PDF: ${error.message} (${AGENT_INFO.companyName})`);
        }
    }
    
    function saveClientsToLocalStorage() {
        try {
            localStorage.setItem('mercatImmoClientsDB', JSON.stringify(clients)); // Updated key
        } catch (e) {
            alert(`Error al guardar clientes: ${(e.name === 'QuotaExceededError' ? "Límite de almacenamiento excedido." : e.message)} (${AGENT_INFO.companyName})`);
        }
    }
    function loadClients() {
        const savedClients = localStorage.getItem('mercatImmoClientsDB'); // Updated key
        if (savedClients) {
            try {
                clients = JSON.parse(savedClients);
                clients.forEach(c => { 
                    c.id = c.id || Date.now().toString() + Math.random();
                    c.name = c.name || '';
                    c.priceMax = parseFloat(c.priceMax) || 0;
                    c.contribution = parseFloat(c.contribution) || 0;
                    c.status = c.status || 'seguimiento';
                    c.numRooms = c.numRooms !== undefined ? String(c.numRooms) : null;
                    c.elevator = c.elevator || 'indiferente';
                    c.minSqMeters = c.minSqMeters !== undefined && c.minSqMeters !== null ? parseInt(c.minSqMeters) : null;
                    c.maxSqMeters = c.maxSqMeters !== undefined && c.maxSqMeters !== null ? parseInt(c.maxSqMeters) : null;
                    c.pdfData = c.pdfData || null;
                    c.pdfName = c.pdfName || null;
                });
            } catch (error) {
                console.error("Error loading clients from localStorage:", error);
                clients = [];
            }
        }
    }

    // Generic image previewer
    function previewImage(event, previewElementId) {
        const reader = new FileReader();
        const preview = document.getElementById(previewElementId);
        reader.onload = function(){
            preview.src = reader.result; 
            preview.classList.remove('hidden');
        }
        if (event.target.files[0]) {
            if (event.target.files[0].size > 2 * 1024 * 1024) { 
                alert(`La imagen es muy grande para la vista previa (límite 2MB). Se guardará, pero la vista previa puede no funcionar bien. (${AGENT_INFO.companyName})`);
                preview.src = "#";
                preview.classList.add('hidden');
                 event.target.value = ""; // Clear the file input
            } else {
                reader.readAsDataURL(event.target.files[0]);
            }
        } else {
            preview.src = "#";
            preview.classList.add('hidden');
        }
    }


    function prepareNewPropertyForm() {
        document.getElementById('propertyFormTitle').textContent = 'Añadir Nueva Propiedad (Captada/Colaborador)';
        document.getElementById('propertyForm').reset();
        document.getElementById('propertyElevator').value = 'indiferente';
        document.getElementById('sellerType').value = 'particular';
        const preview = document.getElementById('propertyImagePreview');
        preview.src = "#";
        preview.classList.add('hidden');
        currentEditingPropertyId = null;
        document.getElementById('propertyAddress').focus();
    }
    
    async function saveProperty() { 
        const imageFile = document.getElementById('propertyImageFile').files[0];
        let imageBase64FromPreview = document.getElementById('propertyImagePreview').src;
        
        let finalImageBase64 = null;
        let finalImageName = null;

        if (imageFile) { // New image selected or changed
            try {
                finalImageBase64 = await readFileAsBase64(imageFile);
                finalImageName = imageFile.name;
            } catch (error) {
                alert(`Error procesando la imagen: ${error.message}. La propiedad se guardará sin imagen. (${AGENT_INFO.companyName})`);
            }
        } else if (currentEditingPropertyId) { // Editing, no new file selected
            const oldProperty = properties.find(p => p.id === currentEditingPropertyId);
            if (oldProperty && imageBase64FromPreview !== '#' && !imageBase64FromPreview.startsWith(window.location.origin + "/#")) {
                 // If preview has an image (could be the old one or one set then input cleared)
                 // and it's not the placeholder, keep the old image if no new file
                finalImageBase64 = oldProperty.image;
                finalImageName = oldProperty.imageName;
            }
             // if imageBase64FromPreview is #, it means user cleared preview or it was never set, so image will be null
        }
        // If new property and no file, or preview was cleared, image remains null

        const propertyData = {
            id: currentEditingPropertyId || Date.now().toString() + Math.random().toString(16).slice(2),
            address: document.getElementById('propertyAddress').value.trim(),
            price: parseFloat(document.getElementById('propertyPrice').value) || 0,
            sellerName: document.getElementById('sellerName').value.trim(), // NEW
            sellerPhone: document.getElementById('sellerPhone').value.trim(),
            sellerType: document.getElementById('sellerType').value,
            propertyFloor: document.getElementById('propertyFloor').value.trim(), // NEW
            sqMeters: parseFloat(document.getElementById('propertySqMeters').value) || 0,
            rooms: parseInt(document.getElementById('propertyRooms').value) || 0,
            baths: parseInt(document.getElementById('propertyBaths').value) || 0,
            elevator: document.getElementById('propertyElevator').value,
            propertyURL: document.getElementById('propertyURL').value.trim() || null,
            comments: document.getElementById('propertyComments').value.trim(),
            image: finalImageBase64,
            imageName: finalImageName
        };

        if (!propertyData.address || propertyData.price <= 0) {
            alert(`La dirección y un precio válido son obligatorios para la propiedad. (${AGENT_INFO.companyName})`);
            return;
        }
        
        if (currentEditingPropertyId) {
            const index = properties.findIndex(p => p.id === currentEditingPropertyId);
            if (index !== -1) properties[index] = propertyData;
        } else {
            properties.push(propertyData);
        }
        
        savePropertiesToLocalStorage();
        updatePropertiesTable();
        prepareNewPropertyForm(); 
        alert(`Propiedad en "${propertyData.address}" ${currentEditingPropertyId ? 'actualizada' : 'guardada'} correctamente. (${AGENT_INFO.companyName})`);
    }
    
    function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
            if (file.size > 10 * 1024 * 1024) { 
                reject(new Error(`Archivo demasiado grande para guardar (límite 10MB). (${AGENT_INFO.companyName})`));
                return;
            }
            reader.readAsDataURL(file);
        });
    }
    
    function editProperty(propertyId) {
        const prop = properties.find(p => p.id === propertyId);
        if (prop) {
            document.getElementById('propertyFormTitle').textContent = `Editando Propiedad: ${prop.address}`;
            document.getElementById('propertyId').value = prop.id;
            document.getElementById('propertyAddress').value = prop.address;
            document.getElementById('propertyPrice').value = prop.price;
            document.getElementById('sellerName').value = prop.sellerName || ''; // NEW
            document.getElementById('sellerPhone').value = prop.sellerPhone;
            document.getElementById('sellerType').value = prop.sellerType;
            document.getElementById('propertyFloor').value = prop.propertyFloor || ''; // NEW
            document.getElementById('propertySqMeters').value = prop.sqMeters;
            document.getElementById('propertyRooms').value = prop.rooms;
            document.getElementById('propertyBaths').value = prop.baths;
            document.getElementById('propertyElevator').value = prop.elevator;
            document.getElementById('propertyURL').value = prop.propertyURL || ''; 
            document.getElementById('propertyComments').value = prop.comments;
            
            const preview = document.getElementById('propertyImagePreview');
            if (prop.image && prop.image !== "#") {
                preview.src = prop.image;
                preview.classList.remove('hidden');
            } else {
                preview.src = "#";
                preview.classList.add('hidden');
            }
            document.getElementById('propertyImageFile').value = ''; 
            currentEditingPropertyId = prop.id;
            
            const formTabButton = document.querySelector('.tab-btn[data-tab="vendedores"]');
            if(formTabButton) formTabButton.click();
            
            document.getElementById('propertyAddress').focus();
            document.getElementById('propertyForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    function deleteProperty(propertyId) {
        const propIndex = properties.findIndex(p => p.id === propertyId);
        if (propIndex !== -1) {
            if (confirm(`¿Está seguro de que desea eliminar la propiedad en "${properties[propIndex].address}"? (${AGENT_INFO.companyName})`)) {
                properties.splice(propIndex, 1);
                savePropertiesToLocalStorage();
                updatePropertiesTable();
                if (currentEditingPropertyId === propertyId) { 
                    prepareNewPropertyForm();
                }
                alert(`Propiedad eliminada. (${AGENT_INFO.companyName})`);
                closeModal('propertyDetailsModal');
            }
        }
    }

    function updatePropertiesTable() {
        const tbody = document.querySelector('#propertiesTable tbody');
        const noDataMsg = document.getElementById('noPropertiesMessage');
        if (!tbody || !noDataMsg) return;
        tbody.innerHTML = '';

        if (properties.length === 0) {
            noDataMsg.style.display = 'block';
        } else {
            noDataMsg.style.display = 'none';
            properties.forEach(prop => {
                const row = tbody.insertRow();
                const imageSrc = (prop.image && prop.image !== "#") ? prop.image : 'https://via.placeholder.com/150x100.png?text=Sin+Imagen';
                const urlDisplay = prop.propertyURL ? `<a href="${prop.propertyURL.startsWith('http') ? prop.propertyURL : 'https://' + prop.propertyURL}" target="_blank" class="text-blue-500 hover:underline">${prop.propertyURL.length > 20 ? prop.propertyURL.substring(0,20) + '...' : prop.propertyURL}</a>` : '-';
                row.innerHTML = `
                    <td><img src="${imageSrc}" alt="Propiedad" class="thumbnail-image cursor-pointer" onclick="zoomPropertyImage('${imageSrc}')"></td>
                    <td>${prop.address}</td>
                    <td>${formatCurrency(prop.price)}</td>
                    <td>${prop.sellerName || '-'}</td>
                    <td>${prop.sellerPhone || '-'}</td>
                    <td>${getStatusText(prop.sellerType, 'sellerType')}</td>
                    <td>${prop.propertyFloor || '-'}</td>
                    <td>${prop.sqMeters || '-'} m²</td>
                    <td>${prop.rooms === 0 ? 'Estudio' : (prop.rooms || '-')}</td>
                    <td>${prop.baths || '-'}</td>
                    <td>${getStatusText(prop.elevator, 'propertyElevator')}</td>
                    <td>${urlDisplay}</td>
                    <td>
                        <div class="flex space-x-1">
                            <button data-action="view" data-id="${prop.id}" data-type="property" class="text-blue-600 hover:text-blue-800 p-1" title="Ver Detalles"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></button>
                            <button data-action="edit" data-id="${prop.id}" data-type="property" class="text-yellow-600 hover:text-yellow-800 p-1" title="Editar Propiedad"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                            <button data-action="delete" data-id="${prop.id}" data-type="property" class="text-red-600 hover:text-red-800 p-1" title="Eliminar Propiedad"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div>
                    </td>
                `;
            });
        }
        addTableActionListeners('propertiesTable', 'property');
    }
    
    function showPropertyDetailsModal(propertyId) {
        const prop = properties.find(p => p.id === propertyId);
        if (prop) {
            document.getElementById('modalPropertyAddress').textContent = prop.address;
            const modalImage = document.getElementById('modalPropertyImage');
            if (prop.image && prop.image !== "#") {
                modalImage.src = prop.image;
                modalImage.classList.remove('hidden');
            } else {
                modalImage.src = "#";
                modalImage.classList.add('hidden');
            }
            document.getElementById('modalPropertyPrice').textContent = formatCurrency(prop.price);
            document.getElementById('modalSellerName').textContent = prop.sellerName || '-'; // NEW
            document.getElementById('modalSellerPhone').textContent = prop.sellerPhone || '-';
            document.getElementById('modalSellerType').textContent = getStatusText(prop.sellerType, 'sellerType');
            document.getElementById('modalPropertyFloor').textContent = prop.propertyFloor || '-'; // NEW
            document.getElementById('modalPropertySqMeters').textContent = prop.sqMeters || '-';
            document.getElementById('modalPropertyRooms').textContent = prop.rooms === 0 ? 'Estudio' : (prop.rooms || '-');
            document.getElementById('modalPropertyBaths').textContent = prop.baths || '-';
            document.getElementById('modalPropertyElevator').textContent = getStatusText(prop.elevator, 'propertyElevator');
            document.getElementById('modalPropertyURL').textContent = prop.propertyURL || '-';
            document.getElementById('modalPropertyComments').textContent = prop.comments || '-';

            document.getElementById('exportPropertyPDFBtn').setAttribute('data-property-id', prop.id);
            const viewOnlineBtn = document.getElementById('viewPropertyOnlineBtn');
            viewOnlineBtn.setAttribute('data-property-id', prop.id);
            if (prop.propertyURL) {
                viewOnlineBtn.removeAttribute('disabled');
            } else {
                viewOnlineBtn.setAttribute('disabled', true);
            }
            document.getElementById('editPropertyModalBtn').setAttribute('data-property-id', prop.id);
            document.getElementById('deletePropertyModalBtn').setAttribute('data-property-id', prop.id);
            
            document.getElementById('propertyDetailsModal').style.display = 'block';
        }
    }

    function savePropertiesToLocalStorage() {
        try {
            localStorage.setItem('mercatImmoPropertiesDB', JSON.stringify(properties)); // Updated key
        } catch (e) {
             alert(`Error al guardar propiedades: ${(e.name === 'QuotaExceededError' ? "Límite de almacenamiento excedido." : e.message)} (${AGENT_INFO.companyName})`);
        }
    }
    function loadProperties() {
        const savedProperties = localStorage.getItem('mercatImmoPropertiesDB'); // Updated key
        if (savedProperties) {
            try {
                properties = JSON.parse(savedProperties);
                properties.forEach(p => {
                    p.id = p.id || Date.now().toString() + Math.random();
                    p.price = parseFloat(p.price) || 0;
                    p.sellerName = p.sellerName || ''; // NEW
                    p.sellerType = p.sellerType || 'particular';
                    p.propertyFloor = p.propertyFloor || ''; // NEW
                    p.sqMeters = parseFloat(p.sqMeters) || 0;
                    p.rooms = parseInt(p.rooms) || 0;
                    p.baths = parseInt(p.baths) || 0;
                    p.elevator = p.elevator || 'indiferente';
                    p.propertyURL = p.propertyURL || null; 
                });
            } catch (error) {
                console.error("Error loading properties from localStorage:", error);
                properties = [];
            }
        }
    }

    // --- Funciones para Seguimiento Vendedores Particulares (NEW SECTION) ---
    function prepareNewPrivateSellerForm() {
        document.getElementById('privateSellerFormTitle').textContent = 'Añadir Vendedor Particular para Seguimiento';
        document.getElementById('privateSellerForm').reset();
        document.getElementById('privateSellerStatus').value = 'seguimiento';
        document.getElementById('privateSellerPropertyElevator').value = 'indiferente';
        const preview = document.getElementById('privateSellerPropertyImagePreview');
        preview.src = "#";
        preview.classList.add('hidden');
        currentEditingPrivateSellerId = null;
        document.getElementById('privateSellerOwnerName').focus();
    }

    async function savePrivateSeller() {
        const imageFile = document.getElementById('privateSellerPropertyImageFile').files[0];
        let imageBase64FromPreview = document.getElementById('privateSellerPropertyImagePreview').src;
        
        let finalImageBase64 = null;
        let finalImageName = null;

        if (imageFile) {
            try {
                finalImageBase64 = await readFileAsBase64(imageFile);
                finalImageName = imageFile.name;
            } catch (error) {
                alert(`Error procesando la imagen: ${error.message}. Se guardará sin imagen. (${AGENT_INFO.companyName})`);
            }
        } else if (currentEditingPrivateSellerId) {
            const oldPs = privateSellers.find(ps => ps.id === currentEditingPrivateSellerId);
            if (oldPs && imageBase64FromPreview !== '#' && !imageBase64FromPreview.startsWith(window.location.origin + "/#")) {
                finalImageBase64 = oldPs.propertyImage;
                finalImageName = oldPs.propertyImageName;
            }
        }

        const privateSellerData = {
            id: currentEditingPrivateSellerId || Date.now().toString() + Math.random().toString(16).slice(2),
            ownerName: document.getElementById('privateSellerOwnerName').value.trim(),
            ownerPhone: document.getElementById('privateSellerOwnerPhone').value.trim(),
            ownerEmail: document.getElementById('privateSellerOwnerEmail').value.trim(),
            status: document.getElementById('privateSellerStatus').value,
            propertyAddress: document.getElementById('privateSellerPropertyAddress').value.trim(),
            propertyZone: document.getElementById('privateSellerPropertyZone').value.trim(),
            propertyFloor: document.getElementById('privateSellerPropertyFloor').value.trim(),
            propertyRooms: parseInt(document.getElementById('privateSellerPropertyRooms').value) || 0,
            propertySqMeters: parseFloat(document.getElementById('privateSellerPropertySqMeters').value) || 0,
            propertyElevator: document.getElementById('privateSellerPropertyElevator').value,
            propertyURL: document.getElementById('privateSellerPropertyURL').value.trim() || null,
            propertyImage: finalImageBase64,
            propertyImageName: finalImageName,
            comments: document.getElementById('privateSellerComments').value.trim()
        };

        if (!privateSellerData.ownerName || !privateSellerData.propertyAddress) {
            alert(`El nombre del propietario y la dirección del inmueble son obligatorios. (${AGENT_INFO.companyName})`);
            return;
        }

        if (currentEditingPrivateSellerId) {
            const index = privateSellers.findIndex(ps => ps.id === currentEditingPrivateSellerId);
            if (index !== -1) privateSellers[index] = privateSellerData;
        } else {
            privateSellers.push(privateSellerData);
        }

        savePrivateSellersToLocalStorage();
        updatePrivateSellersTable();
        prepareNewPrivateSellerForm();
        alert(`Vendedor particular "${privateSellerData.ownerName}" ${currentEditingPrivateSellerId ? 'actualizado' : 'guardado'} correctamente. (${AGENT_INFO.companyName})`);
    }

    function editPrivateSeller(privateSellerId) {
        const ps = privateSellers.find(p => p.id === privateSellerId);
        if (ps) {
            document.getElementById('privateSellerFormTitle').textContent = `Editando Vendedor Particular: ${ps.ownerName}`;
            document.getElementById('privateSellerId').value = ps.id;
            document.getElementById('privateSellerOwnerName').value = ps.ownerName;
            document.getElementById('privateSellerOwnerPhone').value = ps.ownerPhone;
            document.getElementById('privateSellerOwnerEmail').value = ps.ownerEmail;
            document.getElementById('privateSellerStatus').value = ps.status;
            document.getElementById('privateSellerPropertyAddress').value = ps.propertyAddress;
            document.getElementById('privateSellerPropertyZone').value = ps.propertyZone;
            document.getElementById('privateSellerPropertyFloor').value = ps.propertyFloor;
            document.getElementById('privateSellerPropertyRooms').value = ps.propertyRooms;
            document.getElementById('privateSellerPropertySqMeters').value = ps.propertySqMeters;
            document.getElementById('privateSellerPropertyElevator').value = ps.propertyElevator;
            document.getElementById('privateSellerPropertyURL').value = ps.propertyURL || '';
            document.getElementById('privateSellerComments').value = ps.comments;

            const preview = document.getElementById('privateSellerPropertyImagePreview');
            if (ps.propertyImage && ps.propertyImage !== "#") {
                preview.src = ps.propertyImage;
                preview.classList.remove('hidden');
            } else {
                preview.src = "#";
                preview.classList.add('hidden');
            }
            document.getElementById('privateSellerPropertyImageFile').value = '';
            currentEditingPrivateSellerId = ps.id;

            const formTabButton = document.querySelector('.tab-btn[data-tab="seguimientoParticulares"]');
            if(formTabButton) formTabButton.click();
            
            document.getElementById('privateSellerOwnerName').focus();
            document.getElementById('privateSellerForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    function deletePrivateSeller(privateSellerId) {
        const psIndex = privateSellers.findIndex(p => p.id === privateSellerId);
        if (psIndex !== -1) {
            if (confirm(`¿Está seguro de que desea eliminar al vendedor particular "${privateSellers[psIndex].ownerName}" de la lista de seguimiento? (${AGENT_INFO.companyName})`)) {
                privateSellers.splice(psIndex, 1);
                savePrivateSellersToLocalStorage();
                updatePrivateSellersTable();
                if (currentEditingPrivateSellerId === privateSellerId) {
                    prepareNewPrivateSellerForm();
                }
                alert(`Vendedor particular eliminado del seguimiento. (${AGENT_INFO.companyName})`);
                closeModal('privateSellerDetailsModal');
            }
        }
    }

    function updatePrivateSellersTable() {
        const tbody = document.querySelector('#privateSellersTable tbody');
        const noDataMsg = document.getElementById('noPrivateSellersMessage');
        if (!tbody || !noDataMsg) return;
        tbody.innerHTML = '';

        const statusFilter = document.getElementById('filterPrivateSellerStatus').value;
        const zoneFilter = document.getElementById('filterPrivateSellerZone').value.toLowerCase();

        const filteredPrivateSellers = privateSellers.filter(ps => {
            const statusMatch = statusFilter === 'todos' || ps.status === statusFilter;
            const zoneMatch = !zoneFilter || (ps.propertyZone && ps.propertyZone.toLowerCase().includes(zoneFilter));
            return statusMatch && zoneMatch;
        });

        if (filteredPrivateSellers.length === 0) {
            noDataMsg.style.display = 'block';
        } else {
            noDataMsg.style.display = 'none';
            filteredPrivateSellers.forEach(ps => {
                const row = tbody.insertRow();
                const urlDisplay = ps.propertyURL ? `<a href="${ps.propertyURL.startsWith('http') ? ps.propertyURL : 'https://' + ps.propertyURL}" target="_blank" class="text-blue-500 hover:underline">${ps.propertyURL.length > 20 ? ps.propertyURL.substring(0,20) + '...' : ps.propertyURL}</a>` : '-';
                row.innerHTML = `
                    <td>${ps.ownerName}</td>
                    <td>${ps.ownerPhone || '-'}</td>
                    <td>${ps.propertyAddress}</td>
                    <td>${ps.propertyZone || '-'}</td>
                    <td>${ps.propertyRooms === 0 ? 'Estudio' : (ps.propertyRooms || '-')}</td>
                    <td>${ps.propertySqMeters || '-'} m²</td>
                    <td>${getStatusText(ps.propertyElevator, 'propertyElevator')}</td>
                    <td><span class="px-2 py-1 rounded-full text-xs font-semibold ${getStatusColorClass(ps.status, 'privateSeller')}">${getStatusText(ps.status, 'privateSellerStatus')}</span></td>
                    <td>${urlDisplay}</td>
                    <td>
                        <div class="flex space-x-1 items-center">
                            <button data-action="view" data-id="${ps.id}" data-type="privateSeller" class="text-blue-600 hover:text-blue-800 p-1" title="Ver Detalles"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></button>
                            <button data-action="edit" data-id="${ps.id}" data-type="privateSeller" class="text-yellow-600 hover:text-yellow-800 p-1" title="Editar Seguimiento"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                            <button data-action="delete" data-id="${ps.id}" data-type="privateSeller" class="text-red-600 hover:text-red-800 p-1" title="Eliminar Seguimiento"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                            <button data-action="whatsapp" data-id="${ps.id}" data-type="privateSeller" class="btn-whatsapp p-1" title="Contactar por WhatsApp">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.47.074-.742.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.076 4.487.709.306 1.262.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                            </button>
                            <button data-action="schedule-gcal" data-id="${ps.id}" data-type="privateSeller" class="text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 p-1" title="Agendar Seguimiento en Google Calendar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </td>
                `;
            });
        }
        addTableActionListeners('privateSellersTable', 'privateSeller');
    }
    
    function resetPrivateSellerFilters() {
        document.getElementById('filterPrivateSellerStatus').value = 'todos';
        document.getElementById('filterPrivateSellerZone').value = '';
        updatePrivateSellersTable();
    }

    function showPrivateSellerDetailsModal(privateSellerId) {
        const ps = privateSellers.find(p => p.id === privateSellerId);
        if (ps) {
            document.getElementById('modalPrivateSellerOwnerName').textContent = ps.ownerName;
            const modalImage = document.getElementById('modalPrivateSellerPropertyImage');
             if (ps.propertyImage && ps.propertyImage !== "#") {
                modalImage.src = ps.propertyImage;
                modalImage.classList.remove('hidden');
            } else {
                modalImage.src = "#";
                modalImage.classList.add('hidden');
            }
            document.getElementById('modalPrivateSellerOwnerPhone').textContent = ps.ownerPhone || '-';
            document.getElementById('modalPrivateSellerOwnerEmail').textContent = ps.ownerEmail || '-';
            document.getElementById('modalPrivateSellerPropertyAddress').textContent = ps.propertyAddress || '-';
            document.getElementById('modalPrivateSellerPropertyZone').textContent = ps.propertyZone || '-';
            document.getElementById('modalPrivateSellerPropertyFloor').textContent = ps.propertyFloor || '-';
            document.getElementById('modalPrivateSellerPropertyRooms').textContent = ps.propertyRooms === 0 ? 'Estudio' : (ps.propertyRooms || '-');
            document.getElementById('modalPrivateSellerPropertySqMeters').textContent = ps.propertySqMeters || '-';
            document.getElementById('modalPrivateSellerPropertyElevator').textContent = getStatusText(ps.propertyElevator, 'propertyElevator');
            document.getElementById('modalPrivateSellerStatus').textContent = getStatusText(ps.status, 'privateSellerStatus');
            document.getElementById('modalPrivateSellerPropertyURL').textContent = ps.propertyURL || '-';
            document.getElementById('modalPrivateSellerComments').textContent = ps.comments || '-';

            document.getElementById('exportPrivateSellerPDFBtn').setAttribute('data-privateseller-id', ps.id);
            const viewOnlineBtn = document.getElementById('viewPrivateSellerPropertyOnlineBtn');
            viewOnlineBtn.setAttribute('data-privateseller-id', ps.id);
            viewOnlineBtn.disabled = !ps.propertyURL;
            
            document.getElementById('editPrivateSellerModalBtn').setAttribute('data-privateseller-id', ps.id);
            document.getElementById('deletePrivateSellerModalBtn').setAttribute('data-privateseller-id', ps.id);
            document.getElementById('scheduleGCalPrivateSellerBtn').setAttribute('data-privateseller-id', ps.id); // Set ID for GCal button
            
            document.getElementById('privateSellerDetailsModal').style.display = 'block';
        }
    }
    
    function sendWhatsAppToPrivateSeller(privateSellerId) {
        const ps = privateSellers.find(p => p.id === privateSellerId);
        if (!ps) {
            alert(`Vendedor particular no encontrado. (${AGENT_INFO.companyName})`);
            return;
        }
        if (!ps.ownerPhone || ps.ownerPhone.trim() === "") {
            alert(`El vendedor particular "${ps.ownerName}" no tiene un número de teléfono registrado. (${AGENT_INFO.companyName})`);
            return;
        }

        let phoneNumber = ps.ownerPhone.replace(/\s+/g, '').replace(/[^0-9+]/g, '');
        if (phoneNumber.startsWith('+')) {
            phoneNumber = phoneNumber.substring(1);
        }
        if (phoneNumber.length === 9 && !phoneNumber.startsWith('34')) {
            phoneNumber = '34' + phoneNumber;
        }

        const message = `Hola, soy ${AGENT_INFO.name} de ${AGENT_INFO.companyName}. Me gustaría saber si puedo llevarte clientes compradores, tengo clientes a los cuales les estoy llevando la hipoteca y están listos para la compra. ¿Podríamos hablar sobre tu propiedad en ${ps.propertyAddress}?`;
        const encodedMessage = encodeURIComponent(message);
        const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
        window.open(whatsappURL, '_blank');
    }

    function generateGoogleCalendarLink(privateSellerId) {
        const ps = privateSellers.find(p => p.id === privateSellerId);
        if (!ps) {
            alert("Vendedor particular no encontrado para agendar.");
            return;
        }

        const defaultEventDate = new Date();
        defaultEventDate.setDate(defaultEventDate.getDate() + 1); // Mañana por defecto
        const eventDateStr = prompt(
            "Introduce la FECHA del seguimiento (YYYY-MM-DD):", 
            defaultEventDate.toISOString().split('T')[0]
        );
        if (!eventDateStr || !/^\d{4}-\d{2}-\d{2}$/.test(eventDateStr)) {
            alert("Fecha inválida. Formato esperado: YYYY-MM-DD");
            return; 
        }

        const eventTimeStr = prompt("Introduce la HORA del seguimiento (HH:MM, formato 24h):", "10:00");
        if (!eventTimeStr || !/^\d{2}:\d{2}$/.test(eventTimeStr)) {
            alert("Hora inválida. Formato esperado: HH:MM");
            return;
        }

        try {
            const startDate = new Date(`${eventDateStr}T${eventTimeStr}:00`);
            if (isNaN(startDate.getTime())) {
                alert("Fecha u hora no válida. Inténtalo de nuevo.");
                return;
            }
            const endDate = new Date(startDate.getTime() + 30 * 60000); // Evento de 30 minutos

            const formatGoogleDate = (date) => {
                // Formato YYYYMMDDTHHMMSSZ (UTC)
                return date.toISOString().replace(/-|:|\.\d+/g, "") + 'Z';
            };
            
            // Convert local start/end dates to UTC for Google Calendar link
            const startDateUTC = new Date(startDate.valueOf() - (startDate.getTimezoneOffset() * 60000));
            const endDateUTC = new Date(endDate.valueOf() - (endDate.getTimezoneOffset() * 60000));


            const eventTitle = `Seguimiento: ${ps.ownerName} - ${ps.propertyAddress}`;
            const eventDetails = `Realizar seguimiento al vendedor particular:
Propietario: ${ps.ownerName}
Teléfono: ${ps.ownerPhone || 'N/A'}
Email: ${ps.ownerEmail || 'N/A'}
Inmueble: ${ps.propertyAddress}
URL Anuncio: ${ps.propertyURL || 'N/A'}
Comentarios Guardados: ${ps.comments || 'Sin comentarios adicionales.'}

Agendado desde MERCAT IMMOBILIARI App.`;

            const calendarUrl = new URL("https://calendar.google.com/calendar/render");
            calendarUrl.searchParams.append("action", "TEMPLATE");
            calendarUrl.searchParams.append("text", eventTitle);
            calendarUrl.searchParams.append("dates", `${formatGoogleDate(startDateUTC)}/${formatGoogleDate(endDateUTC)}`);
            calendarUrl.searchParams.append("details", eventDetails);
            if (ps.propertyAddress) {
                calendarUrl.searchParams.append("location", ps.propertyAddress);
            }
            calendarUrl.searchParams.append("add", AGENT_INFO.email); // Añadirte como invitado

            window.open(calendarUrl.toString(), "_blank");
        } catch (e) {
            alert("Error al generar el enlace del calendario: " + e.message);
            console.error("Error in generateGoogleCalendarLink: ", e);
        }
    }


    function savePrivateSellersToLocalStorage() {
        try {
            localStorage.setItem('mercatImmoPrivateSellersDB', JSON.stringify(privateSellers)); // Updated key
        } catch (e) {
            alert(`Error al guardar vendedores particulares: ${(e.name === 'QuotaExceededError' ? "Límite de almacenamiento excedido." : e.message)} (${AGENT_INFO.companyName})`);
        }
    }

    function loadPrivateSellers() {
        const savedPrivateSellers = localStorage.getItem('mercatImmoPrivateSellersDB'); // Updated key
        if (savedPrivateSellers) {
            try {
                privateSellers = JSON.parse(savedPrivateSellers);
                privateSellers.forEach(ps => {
                    ps.id = ps.id || Date.now().toString() + Math.random().toString(16).slice(2);
                    ps.propertyRooms = parseInt(ps.propertyRooms) || 0;
                    ps.propertySqMeters = parseFloat(ps.propertySqMeters) || 0;
                    ps.status = ps.status || 'seguimiento';
                    ps.propertyElevator = ps.propertyElevator || 'indiferente';
                });
            } catch (error) {
                console.error("Error loading private sellers from localStorage:", error);
                privateSellers = [];
            }
        }
    }
    // --- Fin Funciones Seguimiento Vendedores Particulares ---

    function performCrossReferencing() {
        const resultsContainer = document.getElementById('cruceResults');
        resultsContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Procesando cruce...</p>';
        let matchesFoundOverall = false;
        let htmlResult = '';

        clients.forEach(client => {
            if (client.status !== 'activo' && client.status !== 'seguimiento') return; 

            let matchedPropertiesForClient = [];
            properties.forEach(prop => {
                const priceMatch = prop.price <= client.priceMax;

                let roomsMatch = false;
                const clientRoomsStr = String(client.numRooms || '').toLowerCase().trim();
                const propRooms = parseInt(prop.rooms);

                if (!clientRoomsStr || clientRoomsStr === "null" || clientRoomsStr === "-") { 
                    roomsMatch = true; 
                } else if (clientRoomsStr === "estudio" || clientRoomsStr === "0") {
                    roomsMatch = propRooms === 0;
                } else if (clientRoomsStr.includes("+")) { 
                    const minRooms = parseInt(clientRoomsStr.replace("+", ""));
                    if (!isNaN(minRooms)) roomsMatch = propRooms >= minRooms;
                } else if (clientRoomsStr.match(/^\d+$/)) { 
                    roomsMatch = propRooms === parseInt(clientRoomsStr);
                } else if (clientRoomsStr.includes("o") || clientRoomsStr.includes("-") || clientRoomsStr.includes(",")) { 
                    const roomOptions = clientRoomsStr.split(/\s*o\s*|\s*-\s*|\s*,\s*/).map(r => parseInt(r.trim())).filter(r => !isNaN(r));
                    if (roomOptions.length > 0) {
                         if (roomOptions.length === 1) roomsMatch = propRooms === roomOptions[0];
                         else if (roomOptions.length === 2) roomsMatch = propRooms >= Math.min(...roomOptions) && propRooms <= Math.max(...roomOptions);
                         else roomsMatch = roomOptions.includes(propRooms);
                    }
                }

                let elevatorMatch = false;
                const clientElevatorPref = client.elevator; 
                const propElevatorStatus = prop.elevator; 
                const propertyIsOnFloor = prop.propertyFloor ? prop.propertyFloor.toLowerCase() : '';


                if (clientElevatorPref === 'indiferente') {
                    elevatorMatch = true;
                } else if (clientElevatorPref === 'si') { 
                    elevatorMatch = (propElevatorStatus === 'si');
                } else if (clientElevatorPref === 'no') { 
                     elevatorMatch = true; // Client accepts no elevator at all
                } else if (clientElevatorPref && clientElevatorPref.startsWith('no_indispensable_')) {
                    const maxFloorWithoutElevator = parseInt(clientElevatorPref.split('_').pop());
                     let actualFloorNumber = Infinity;
                     if(propertyIsOnFloor.includes('bajo') || propertyIsOnFloor.includes('entresuelo')) actualFloorNumber = 0;
                     else {
                        const floorMatch = propertyIsOnFloor.match(/\d+/);
                        if(floorMatch) actualFloorNumber = parseInt(floorMatch[0]);
                     }
                    
                    if (propElevatorStatus === 'si') elevatorMatch = true; // Has elevator, always good
                    else if (propElevatorStatus === 'no' && actualFloorNumber <= maxFloorWithoutElevator) elevatorMatch = true; // No elevator, but client accepts for this floor or lower
                    else if (propElevatorStatus === 'indiferente' && actualFloorNumber <= maxFloorWithoutElevator) elevatorMatch = true; // Elevator unknown, but client accepts for this floor or lower
                }


                if (priceMatch && roomsMatch && elevatorMatch) {
                    matchedPropertiesForClient.push(prop);
                    matchesFoundOverall = true;
                }
            });

            if (matchedPropertiesForClient.length > 0) {
                htmlResult += `<div class="mb-8 p-5 border rounded-lg dark:border-gray-700 bg-white dark:bg-gray-800 shadow-md">
                                 <h3 class="text-lg font-semibold text-blue-600 dark:text-blue-400 mb-2">
                                   Cliente: ${client.name} 
                                   <button class="text-xs text-gray-500 hover:underline ml-2" onclick="showClientDetailsModal('${client.id}')">(Ver Ficha Cliente)</button>
                                 </h3>
                                 <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Precio Máx: ${formatCurrency(client.priceMax)}, Habitaciones: ${client.numRooms || 'N/A'}, Ascensor: ${getStatusText(client.elevator, 'elevator')}</p>
                                 <ul class="space-y-4">`;
                matchedPropertiesForClient.forEach(p => {
                    const imgSrc = (p.image && p.image !== "#") ? p.image : 'https://via.placeholder.com/150x110.png?text=N/A';
                    let onlineLinkHtml = '';
                    if (p.propertyURL) {
                         let url = p.propertyURL;
                         if (!url.startsWith('http://') && !url.startsWith('https://')) {
                            url = 'https://' + url;
                         }
                        onlineLinkHtml = `<a href="${url}" target="_blank" class="text-xs text-emerald-500 hover:underline ml-2">(Ver Anuncio)</a>`;
                    }
                    htmlResult += `<li class="flex items-start p-3 border-t dark:border-gray-700 first:border-t-0">
                                     <img src="${imgSrc}" alt="${p.address}" class="matched-property-thumbnail" onclick="zoomPropertyImage('${imgSrc}')">
                                     <div class="flex-1">
                                       <p class="font-medium">${p.address} (${p.propertyFloor || 'Planta N/A'})</p>
                                       <p class="text-sm text-gray-600 dark:text-gray-400">Precio: ${formatCurrency(p.price)}, Hab: ${p.rooms === 0 ? 'Estudio' : p.rooms}, Ascensor: ${getStatusText(p.elevator, 'propertyElevator')}
                                         <button class="text-xs text-blue-500 hover:underline ml-2" onclick="showPropertyDetailsModal('${p.id}')">(Ver Ficha Propiedad)</button>
                                         ${onlineLinkHtml}
                                       </p>
                                       <button class="btn-whatsapp mt-2" onclick="sharePropertyViaWhatsApp('${client.id}', '${p.id}')">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.47.074-.742.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.076 4.487.709.306 1.262.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                                            WhatsApp
                                        </button>
                                     </div>
                                   </li>`;
                });
                htmlResult += `</ul></div>`;
            }
        });

        if (!matchesFoundOverall) {
            resultsContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-6">No se encontraron cruces para los clientes activos o en seguimiento con las propiedades disponibles según los criterios. (${AGENT_INFO.companyName})</p>`;
        } else {
            resultsContainer.innerHTML = htmlResult;
        }
    }
    
    function zoomPropertyImage(imageBase64) {
        if (!imageBase64 || imageBase64 === '#' || imageBase64.includes('via.placeholder.com')) {
            return; 
        }
        document.getElementById('zoomedImage').src = imageBase64;
        document.getElementById('imageZoomModal').style.display = 'block';
    }

    function exportClientDetailsToPDF(clientId) {
        const client = clients.find(c => c.id === clientId);
        if (!client) { alert(`Cliente no encontrado. (${AGENT_INFO.companyName})`); return; }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

        doc.setFontSize(16); doc.setTextColor(30,100,200);
        doc.text(AGENT_INFO.companyName.toUpperCase() + " - FICHA CLIENTE COMPRADOR", 105, 15, { align: 'center' });
        doc.setFontSize(10); doc.setTextColor(80,80,80);
        const agentLine1 = `${AGENT_INFO.title} ${AGENT_INFO.name}`;
        const agentLine2 = `Tlf: ${AGENT_INFO.phone} | Email: ${AGENT_INFO.email}`;
        doc.text(agentLine1, 105, 22, { align: 'center' });
        doc.text(agentLine2, 105, 27, { align: 'center' });
        doc.text(`Fecha Ficha: ${new Date().toLocaleDateString()}`, 105, 32, {align: 'center'});
        doc.setLineWidth(0.5); doc.line(20, 38, 190, 38);

        let yPos = 48;
        const fieldMargin = 7; const valueOffset = 60; const sectionTitleColor = [20,80,160];

        function addField(label, value) {
            if (yPos > 270) { doc.addPage(); yPos = 20; }
            doc.setFontSize(11); doc.setTextColor(40,40,40); doc.text(label + ":", 20, yPos);
            doc.setFontSize(10); doc.setTextColor(70,70,70);
            const textLines = doc.splitTextToSize(String(value || '-'), 190 - (20 + valueOffset) - 5);
            doc.text(textLines, 20 + valueOffset, yPos, {lineHeightFactor: 1.15});
            yPos += (textLines.length * (doc.getLineHeight() / doc.internal.scaleFactor * 1.15)) + fieldMargin - (textLines.length > 1 ? 3 : 5) ;
        }
        
        doc.setFontSize(13); doc.setTextColor(sectionTitleColor[0],sectionTitleColor[1],sectionTitleColor[2]);
        doc.text("DATOS DE CONTACTO", 20, yPos); yPos += fieldMargin+3;
        addField("Nombre Completo", client.name);
        addField("Teléfono", client.phone);
        addField("Correo Electrónico", client.email);

        yPos += 5; doc.setLineWidth(0.2); doc.line(20, yPos-3, 190, yPos-3);
        doc.setFontSize(13); doc.setTextColor(sectionTitleColor[0],sectionTitleColor[1],sectionTitleColor[2]);
        doc.text("PREFERENCIAS Y FINANCIACIÓN", 20, yPos); yPos += fieldMargin+3;
        addField("Precio Máximo", formatCurrency(client.priceMax));
        addField("Aportación", formatCurrency(client.contribution));
        addField("Zona(s) Interés", client.zone);
        addField("Hipoteca", getStatusText(client.mortgageApproved, 'mortgage'));
        addField("Estado Cliente", getStatusText(client.status, 'clientStatus'));
        addField("Nº Habitaciones Des.", client.numRooms || '-');
        addField("Ascensor Pref.", getStatusText(client.elevator, 'elevator'));
        addField("m² Mínimos", client.minSqMeters !== null ? client.minSqMeters + ' m²' : '-');
        addField("m² Máximos", client.maxSqMeters !== null ? client.maxSqMeters + ' m²' : '-');

        yPos += 5; doc.setLineWidth(0.2); doc.line(20, yPos-3, 190, yPos-3);
        doc.setFontSize(13); doc.setTextColor(sectionTitleColor[0],sectionTitleColor[1],sectionTitleColor[2]);
        doc.text("COMENTARIOS (CLIENTE)", 20, yPos); yPos += fieldMargin;
        doc.setFontSize(10); doc.setTextColor(70,70,70);
        const comments = client.comments || "Sin comentarios.";
        const splitComments = doc.splitTextToSize(comments, 170); 
        if (yPos + (splitComments.length * 5) > 280) { doc.addPage(); yPos = 20; }
        doc.text(splitComments, 20, yPos, {lineHeightFactor: 1.15});
        yPos += (splitComments.length * 5) + fieldMargin;

        if (client.pdfName) {
             if (yPos > 270) { doc.addPage(); yPos = 20; }
             doc.line(20, yPos-3, 190, yPos-3);
             addField("Documento Adjunto", client.pdfName);
        }
        
        doc.setFontSize(8); doc.setTextColor(150,150,150);
        doc.text(`Ficha generada por ${AGENT_INFO.companyName}`, 105, 288, { align: 'center' });
        doc.save(`Ficha_Cliente_${client.name.replace(/\s+/g, '_')}.pdf`);
    }

    function exportPropertyDetailsToPDF(propertyId) {
        const prop = properties.find(p => p.id === propertyId);
        if (!prop) { alert(`Propiedad no encontrada. (${AGENT_INFO.companyName})`); return; }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

        doc.setFontSize(16); doc.setTextColor(30,100,200);
        doc.text(AGENT_INFO.companyName.toUpperCase() + " - FICHA PROPIEDAD", 105, 15, { align: 'center' });
        doc.setFontSize(10); doc.setTextColor(80,80,80);
        const agentLine1 = `${AGENT_INFO.title} ${AGENT_INFO.name}`;
        const agentLine2 = `Tlf: ${AGENT_INFO.phone} | Email: ${AGENT_INFO.email}`;
        doc.text(agentLine1, 105, 22, { align: 'center' });
        doc.text(agentLine2, 105, 27, { align: 'center' });
        doc.text(`Fecha Ficha: ${new Date().toLocaleDateString()}`, 105, 32, {align: 'center'});
        doc.setLineWidth(0.5); doc.line(20, 38, 190, 38);

        let yPos = 48;
        const fieldMargin = 7; const valueOffset = 60; const sectionTitleColor = [20,80,160];

        function addField(label, value) {
            if (yPos > 270) { doc.addPage(); yPos = 20; }
            doc.setFontSize(11); doc.setTextColor(40,40,40); doc.text(label + ":", 20, yPos);
            doc.setFontSize(10); doc.setTextColor(70,70,70);
            const textLines = doc.splitTextToSize(String(value || '-'), 190 - (20 + valueOffset) - 5);
            doc.text(textLines, 20 + valueOffset, yPos, {lineHeightFactor: 1.15});
            yPos += (textLines.length * (doc.getLineHeight() / doc.internal.scaleFactor * 1.15)) + fieldMargin - (textLines.length > 1 ? 3 : 5) ;
        }
        
        if (prop.image && prop.image !== "#" && prop.image.startsWith('data:image')) {
            try {
                const imgProps = doc.getImageProperties(prop.image);
                const imgWidth = 100; 
                const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                if (yPos + imgHeight > 280) { doc.addPage(); yPos = 20;}
                doc.addImage(prop.image, imgProps.fileType, (210-imgWidth)/2, yPos, imgWidth, imgHeight); 
                yPos += imgHeight + 5;
            } catch(e) { console.error("Error adding image to PDF:", e); }
        }

        doc.setFontSize(13); doc.setTextColor(sectionTitleColor[0],sectionTitleColor[1],sectionTitleColor[2]);
        doc.text("DATOS DE LA PROPIEDAD", 20, yPos); yPos += fieldMargin+3;
        addField("Dirección/Ref.", prop.address);
        addField("Precio Venta", formatCurrency(prop.price));
        addField("Planta Inmueble", prop.propertyFloor || '-'); // NEW
        addField("Metros Cuadrados", (prop.sqMeters || '-') + ' m²');
        addField("Nº Habitaciones", prop.rooms === 0 ? 'Estudio' : (prop.rooms || '-'));
        addField("Nº Baños", prop.baths || '-');
        addField("Ascensor", getStatusText(prop.elevator, 'propertyElevator'));
        if (prop.propertyURL) addField("URL Anuncio", prop.propertyURL);


        yPos += 5; doc.setLineWidth(0.2); doc.line(20, yPos-3, 190, yPos-3);
        doc.setFontSize(13); doc.setTextColor(sectionTitleColor[0],sectionTitleColor[1],sectionTitleColor[2]);
        doc.text("DATOS DEL VENDEDOR/ORIGEN", 20, yPos); yPos += fieldMargin+3;
        addField("Nombre Vendedor/Agencia", prop.sellerName || '-'); // NEW
        addField("Origen", getStatusText(prop.sellerType, 'sellerType'));
        addField("Teléfono Contacto", prop.sellerPhone || '-');
        
        yPos += 5; doc.setLineWidth(0.2); doc.line(20, yPos-3, 190, yPos-3);
        doc.setFontSize(13); doc.setTextColor(sectionTitleColor[0],sectionTitleColor[1],sectionTitleColor[2]);
        doc.text("COMENTARIOS (PROPIEDAD)", 20, yPos); yPos += fieldMargin;
        doc.setFontSize(10); doc.setTextColor(70,70,70);
        const comments = prop.comments || "Sin comentarios.";
        const splitComments = doc.splitTextToSize(comments, 170);
        if (yPos + (splitComments.length * 5) > 280) { doc.addPage(); yPos = 20; }
        doc.text(splitComments, 20, yPos, {lineHeightFactor: 1.15});
        
        doc.setFontSize(8); doc.setTextColor(150,150,150);
        doc.text(`Ficha generada por ${AGENT_INFO.companyName}`, 105, 288, { align: 'center' });
        doc.save(`Ficha_Propiedad_${prop.address.replace(/\s+/g, '_').substring(0,20)}.pdf`);
    }

    function exportPrivateSellerDetailsToPDF(privateSellerId) {
        const ps = privateSellers.find(p => p.id === privateSellerId);
        if (!ps) { alert(`Vendedor particular no encontrado. (${AGENT_INFO.companyName})`); return; }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

        doc.setFontSize(16); doc.setTextColor(30,100,200);
        doc.text(AGENT_INFO.companyName.toUpperCase() + " - FICHA SEGUIMIENTO PARTICULAR", 105, 15, { align: 'center' });
        doc.setFontSize(10); doc.setTextColor(80,80,80);
        const agentLine1 = `${AGENT_INFO.title} ${AGENT_INFO.name}`;
        const agentLine2 = `Tlf: ${AGENT_INFO.phone} | Email: ${AGENT_INFO.email}`;
        doc.text(agentLine1, 105, 22, { align: 'center' });
        doc.text(agentLine2, 105, 27, { align: 'center' });
        doc.text(`Fecha Ficha: ${new Date().toLocaleDateString()}`, 105, 32, {align: 'center'});
        doc.setLineWidth(0.5); doc.line(20, 38, 190, 38);

        let yPos = 48;
        const fieldMargin = 7; const valueOffset = 60; const sectionTitleColor = [20,80,160];

        function addField(label, value, isUrl = false) {
            if (yPos > 270) { doc.addPage(); yPos = 20; }
            doc.setFontSize(11); doc.setTextColor(40,40,40); doc.text(label + ":", 20, yPos);
            doc.setFontSize(10); 
             if (isUrl && value && value !== '-') {
                doc.setTextColor(0,0,255); 
                const urlToLink = value.startsWith('http') ? value : 'https://' + value;
                const textLines = doc.splitTextToSize(String(value || '-'), 190 - (20 + valueOffset) - 5);
                doc.textWithLink(textLines[0] + (textLines.length > 1 ? "..." : ""), 20 + valueOffset, yPos, { url: urlToLink });
                yPos += (textLines.length * (doc.getLineHeight() / doc.internal.scaleFactor * 1.15)) + fieldMargin - (textLines.length > 1 ? 3 : 5) ;
            } else {
                doc.setTextColor(70,70,70);
                const textLines = doc.splitTextToSize(String(value || '-'), 190 - (20 + valueOffset) - 5);
                doc.text(textLines, 20 + valueOffset, yPos, {lineHeightFactor: 1.15});
                yPos += (textLines.length * (doc.getLineHeight() / doc.internal.scaleFactor * 1.15)) + fieldMargin - (textLines.length > 1 ? 3 : 5) ;
            }
        }
        
        if (ps.propertyImage && ps.propertyImage !== "#" && ps.propertyImage.startsWith('data:image')) {
            try {
                const imgProps = doc.getImageProperties(ps.propertyImage);
                const imgWidth = 80; 
                const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                if (yPos + imgHeight > 280) { doc.addPage(); yPos = 20;}
                doc.addImage(ps.propertyImage, imgProps.fileType, (210-imgWidth)/2, yPos, imgWidth, imgHeight); 
                yPos += imgHeight + 5;
            } catch(e) { console.error("Error adding private seller image to PDF:", e); }
        }


        doc.setFontSize(13); doc.setTextColor(sectionTitleColor[0],sectionTitleColor[1],sectionTitleColor[2]);
        doc.text("DATOS DEL PROPIETARIO", 20, yPos); yPos += fieldMargin+3;
        addField("Nombre", ps.ownerName);
        addField("Teléfono", ps.ownerPhone);
        addField("Email", ps.ownerEmail);
        addField("Estado Seguimiento", getStatusText(ps.status, 'privateSellerStatus'));

        yPos += 5; doc.setLineWidth(0.2); doc.line(20, yPos-3, 190, yPos-3);
        doc.setFontSize(13); doc.setTextColor(sectionTitleColor[0],sectionTitleColor[1],sectionTitleColor[2]);
        doc.text("DATOS DEL INMUEBLE", 20, yPos); yPos += fieldMargin+3;
        addField("Dirección", ps.propertyAddress);
        addField("Zona", ps.propertyZone);
        addField("Planta", ps.propertyFloor);
        addField("Habitaciones", ps.propertyRooms === 0 ? 'Estudio' : (ps.propertyRooms || '-'));
        addField("Metros Cuadrados", (ps.propertySqMeters || '-') + ' m²');
        addField("Ascensor", getStatusText(ps.propertyElevator, 'propertyElevator'));
        addField("URL Anuncio", ps.propertyURL, true);
        
        yPos += 5; doc.setLineWidth(0.2); doc.line(20, yPos-3, 190, yPos-3);
        doc.setFontSize(13); doc.setTextColor(sectionTitleColor[0],sectionTitleColor[1],sectionTitleColor[2]);
        doc.text("COMENTARIOS (SEGUIMIENTO)", 20, yPos); yPos += fieldMargin;
        doc.setFontSize(10); doc.setTextColor(70,70,70);
        const comments = ps.comments || "Sin comentarios.";
        const splitComments = doc.splitTextToSize(comments, 170);
        if (yPos + (splitComments.length * 5) > 280) { doc.addPage(); yPos = 20; }
        doc.text(splitComments, 20, yPos, {lineHeightFactor: 1.15});
        
        doc.setFontSize(8); doc.setTextColor(150,150,150);
        doc.text(`Ficha generada por ${AGENT_INFO.companyName}`, 105, 288, { align: 'center' });
        doc.save(`Ficha_Seguimiento_${ps.ownerName.replace(/\s+/g, '_')}.pdf`);
    }


    // Collaborator Functions
    function prepareNewCollaboratorForm() {
        document.getElementById('collaboratorFormTitle').textContent = 'Añadir Nuevo Colaborador';
        document.getElementById('collaboratorForm').reset();
        document.getElementById('collaboratorId').value = '';
        currentEditingCollaboratorId = null;
        document.getElementById('collaboratorName').focus();
    }

    function saveCollaborator() {
        const collaboratorData = {
            id: currentEditingCollaboratorId || Date.now().toString() + Math.random().toString(16).slice(2),
            collaboratorName: document.getElementById('collaboratorName').value.trim(),
            agencyName: document.getElementById('collaboratorAgencyName').value.trim(),
            phone: document.getElementById('collaboratorPhone').value.trim(),
            email: document.getElementById('collaboratorEmail').value.trim(),
            address: document.getElementById('collaboratorAddress').value.trim(),
            url: document.getElementById('collaboratorURL').value.trim() || null,
            comments: document.getElementById('collaboratorComments').value.trim(),
            pdfData: null,
            pdfName: null
        };

        if (!collaboratorData.collaboratorName) {
            alert(`El nombre del colaborador es obligatorio. (${AGENT_INFO.companyName})`);
            return;
        }

        if (currentEditingCollaboratorId) {
            const index = collaborators.findIndex(c => c.id === currentEditingCollaboratorId);
            if (index !== -1) {
                collaboratorData.pdfData = collaborators[index].pdfData; 
                collaboratorData.pdfName = collaborators[index].pdfName;
                collaborators[index] = collaboratorData;
            }
        } else {
            collaborators.push(collaboratorData);
        }
        
        saveCollaboratorsToLocalStorage();
        updateCollaboratorsTable();
        prepareNewCollaboratorForm(); 
        alert(`Colaborador "${collaboratorData.collaboratorName}" ${currentEditingCollaboratorId ? 'actualizado' : 'guardado'} correctamente. (${AGENT_INFO.companyName})`);
    }

    function editCollaborator(collaboratorId) {
        const collaborator = collaborators.find(c => c.id === collaboratorId);
        if (collaborator) {
            document.getElementById('collaboratorFormTitle').textContent = `Editando Colaborador: ${collaborator.collaboratorName}`;
            document.getElementById('collaboratorId').value = collaborator.id; 
            document.getElementById('collaboratorName').value = collaborator.collaboratorName;
            document.getElementById('collaboratorAgencyName').value = collaborator.agencyName;
            document.getElementById('collaboratorPhone').value = collaborator.phone;
            document.getElementById('collaboratorEmail').value = collaborator.email;
            document.getElementById('collaboratorAddress').value = collaborator.address;
            document.getElementById('collaboratorURL').value = collaborator.url || '';
            document.getElementById('collaboratorComments').value = collaborator.comments;
            currentEditingCollaboratorId = collaborator.id;
            
            const formTabButton = document.querySelector('.tab-btn[data-tab="colaboradores"]');
            if(formTabButton) formTabButton.click();
            
            document.getElementById('collaboratorName').focus();
            document.getElementById('collaboratorForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    function deleteCollaborator(collaboratorId) {
        const collaboratorIndex = collaborators.findIndex(c => c.id === collaboratorId);
        if (collaboratorIndex !== -1) {
            if (confirm(`¿Está seguro de que desea eliminar al colaborador "${collaborators[collaboratorIndex].collaboratorName}"? (${AGENT_INFO.companyName})`)) {
                collaborators.splice(collaboratorIndex, 1);
                saveCollaboratorsToLocalStorage();
                updateCollaboratorsTable();
                if (currentEditingCollaboratorId === collaboratorId) { 
                    prepareNewCollaboratorForm();
                }
                alert(`Colaborador eliminado. (${AGENT_INFO.companyName})`);
                closeModal('collaboratorDetailsModal'); 
            }
        }
    }

    function updateCollaboratorsTable() {
        const tbody = document.querySelector('#collaboratorsTable tbody');
        const noDataMsg = document.getElementById('noCollaboratorsMessage');
        if (!tbody || !noDataMsg) return;
        tbody.innerHTML = '';

        if (collaborators.length === 0) {
            noDataMsg.style.display = 'block';
        } else {
            noDataMsg.style.display = 'none';
            collaborators.forEach(collab => {
                const row = tbody.insertRow();
                const urlDisplay = collab.url ? `<a href="${collab.url.startsWith('http') ? collab.url : 'https://' + collab.url}" target="_blank" class="text-blue-500 hover:underline">${collab.url.length > 20 ? collab.url.substring(0,20) + '...' : collab.url}</a>` : '-';
                row.innerHTML = `
                    <td>${collab.collaboratorName}</td>
                    <td>${collab.agencyName || '-'}</td>
                    <td>${collab.phone || '-'}</td>
                    <td>${collab.email || '-'}</td>
                    <td>${collab.address || '-'}</td>
                    <td>${urlDisplay}</td>
                    <td>
                        <button data-action="attach-pdf" data-type="collaborator" data-id="${collab.id}" class="text-green-500 hover:text-green-700 dark:text-green-400 dark:hover:text-green-300 p-1" title="Adjuntar PDF (Colaborador)">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6 10a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 4a1 1 0 100 2h4a1 1 0 100-2H7zM3 3a1 1 0 000 2h14a1 1 0 100-2H3zm2 4a1 1 0 011-1h2a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                        ${collab.pdfData ? `
                        <button data-action="view-pdf" data-type="collaborator" data-id="${collab.id}" class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 ml-1 p-1" title="Ver ${collab.pdfName || 'PDF Colaborador'}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                        </button>` : ''}
                    </td>
                    <td>
                        <div class="flex space-x-1">
                            <button data-action="view" data-id="${collab.id}" data-type="collaborator" class="text-blue-600 hover:text-blue-800 p-1" title="Ver Detalles"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></button>
                            <button data-action="edit" data-id="${collab.id}" data-type="collaborator" class="text-yellow-600 hover:text-yellow-800 p-1" title="Editar Colaborador"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                            <button data-action="delete" data-id="${collab.id}" data-type="collaborator" class="text-red-600 hover:text-red-800 p-1" title="Eliminar Colaborador"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div>
                    </td>
                `;
            });
        }
        addTableActionListeners('collaboratorsTable', 'collaborator');
    }

    function saveCollaboratorsToLocalStorage() {
        try {
            localStorage.setItem('mercatImmoCollaboratorsDB', JSON.stringify(collaborators)); // Updated key
        } catch (e) {
            alert(`Error al guardar colaboradores: ${(e.name === 'QuotaExceededError' ? "Límite de almacenamiento excedido." : e.message)} (${AGENT_INFO.companyName})`);
        }
    }

    function loadCollaborators() {
        const savedCollaborators = localStorage.getItem('mercatImmoCollaboratorsDB'); // Updated key
        if (savedCollaborators) {
            try {
                collaborators = JSON.parse(savedCollaborators);
                collaborators.forEach(c => { 
                    c.id = c.id || Date.now().toString() + Math.random().toString(16).slice(2);
                    c.collaboratorName = c.collaboratorName || '';
                    c.agencyName = c.agencyName || '';
                    c.phone = c.phone || '';
                    c.email = c.email || '';
                    c.address = c.address || '';
                    c.url = c.url || null;
                    c.comments = c.comments || '';
                    c.pdfData = c.pdfData || null;
                    c.pdfName = c.pdfName || null;
                });
            } catch (error) {
                console.error("Error loading collaborators from localStorage:", error);
                collaborators = [];
            }
        }
    }
    
    function showCollaboratorDetailsModal(collaboratorId) {
        const collab = collaborators.find(c => c.id === collaboratorId);
        if (collab) {
            document.getElementById('modalCollaboratorName').textContent = collab.collaboratorName;
            document.getElementById('modalCollaboratorAgencyName').textContent = collab.agencyName || '-';
            document.getElementById('modalCollaboratorPhone').textContent = collab.phone || '-';
            document.getElementById('modalCollaboratorEmail').textContent = collab.email || '-';
            document.getElementById('modalCollaboratorAddress').textContent = collab.address || '-';
            const urlSpan = document.getElementById('modalCollaboratorURL');
            if (collab.url) {
                urlSpan.innerHTML = `<a href="${collab.url.startsWith('http') ? collab.url : 'https://' + collab.url}" target="_blank" class="text-blue-500 hover:underline break-all">${collab.url}</a>`;
            } else {
                urlSpan.textContent = '-';
            }
            document.getElementById('modalCollaboratorComments').textContent = collab.comments || '-';

            document.getElementById('exportCollaboratorPDFBtn').setAttribute('data-collaborator-id', collab.id);
            document.getElementById('editCollaboratorModalBtn').setAttribute('data-collaborator-id', collab.id);
            document.getElementById('deleteCollaboratorModalBtn').setAttribute('data-collaborator-id', collab.id);
            
            const modalPdfSection = document.getElementById('modalCollaboratorPdfSection');
            const modalViewPdfBtn = document.getElementById('modalCollaboratorViewPdfBtn');
            if (collab.pdfData) {
                modalViewPdfBtn.setAttribute('data-collaborator-id', collab.id);
                modalViewPdfBtn.textContent = `Ver ${collab.pdfName || 'PDF Adjunto (Colaborador)'}`;
                modalPdfSection.classList.remove('hidden');
            } else {
                modalPdfSection.classList.add('hidden');
            }
            
            document.getElementById('collaboratorDetailsModal').style.display = 'block';
        }
    }

    function exportCollaboratorDetailsToPDF(collaboratorId) {
        const collab = collaborators.find(c => c.id === collaboratorId);
        if (!collab) { alert(`Colaborador no encontrado. (${AGENT_INFO.companyName})`); return; }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

        doc.setFontSize(16); doc.setTextColor(30,100,200);
        doc.text(AGENT_INFO.companyName.toUpperCase() + " - FICHA COLABORADOR", 105, 15, { align: 'center' });
        doc.setFontSize(10); doc.setTextColor(80,80,80);
        const agentLine1 = `${AGENT_INFO.title} ${AGENT_INFO.name}`;
        const agentLine2 = `Tlf: ${AGENT_INFO.phone} | Email: ${AGENT_INFO.email}`;
        doc.text(agentLine1, 105, 22, { align: 'center' });
        doc.text(agentLine2, 105, 27, { align: 'center' });
        doc.text(`Fecha Ficha: ${new Date().toLocaleDateString()}`, 105, 32, {align: 'center'});
        doc.setLineWidth(0.5); doc.line(20, 38, 190, 38);

        let yPos = 48;
        const fieldMargin = 7; const valueOffset = 60; const sectionTitleColor = [20,80,160];

        function addField(label, value, isUrl = false) {
            if (yPos > 270) { doc.addPage(); yPos = 20; }
            doc.setFontSize(11); doc.setTextColor(40,40,40); doc.text(label + ":", 20, yPos);
            doc.setFontSize(10); 
            if (isUrl && value && value !== '-') {
                doc.setTextColor(0,0,255); 
                const urlToLink = value.startsWith('http') ? value : 'https://' + value;
                const textLines = doc.splitTextToSize(String(value || '-'), 190 - (20 + valueOffset) - 5);
                doc.textWithLink(textLines[0] + (textLines.length > 1 ? "..." : ""), 20 + valueOffset, yPos, { url: urlToLink });
                yPos += (textLines.length * (doc.getLineHeight() / doc.internal.scaleFactor * 1.15)) + fieldMargin - (textLines.length > 1 ? 3 : 5) ;
            } else {
                doc.setTextColor(70,70,70);
                const textLines = doc.splitTextToSize(String(value || '-'), 190 - (20 + valueOffset) - 5);
                doc.text(textLines, 20 + valueOffset, yPos, {lineHeightFactor: 1.15});
                yPos += (textLines.length * (doc.getLineHeight() / doc.internal.scaleFactor * 1.15)) + fieldMargin - (textLines.length > 1 ? 3 : 5) ;
            }
        }
        
        doc.setFontSize(13); doc.setTextColor(sectionTitleColor[0],sectionTitleColor[1],sectionTitleColor[2]);
        doc.text("DATOS DEL COLABORADOR", 20, yPos); yPos += fieldMargin+3;
        addField("Nombre Colaborador", collab.collaboratorName);
        addField("Nombre Agencia", collab.agencyName);
        addField("Teléfono", collab.phone);
        addField("Correo Electrónico", collab.email);
        addField("Dirección", collab.address);
        addField("URL (Web/Perfil)", collab.url, true);

        yPos += 5; doc.setLineWidth(0.2); doc.line(20, yPos-3, 190, yPos-3);
        doc.setFontSize(13); doc.setTextColor(sectionTitleColor[0],sectionTitleColor[1],sectionTitleColor[2]);
        doc.text("COMENTARIOS ADICIONALES", 20, yPos); yPos += fieldMargin;
        doc.setFontSize(10); doc.setTextColor(70,70,70);
        const comments = collab.comments || "Sin comentarios.";
        const splitComments = doc.splitTextToSize(comments, 170); 
        if (yPos + (splitComments.length * (doc.getLineHeight() / doc.internal.scaleFactor * 1.15)) > 280) { doc.addPage(); yPos = 20; }
        doc.text(splitComments, 20, yPos, {lineHeightFactor: 1.15});
        yPos += (splitComments.length * (doc.getLineHeight() / doc.internal.scaleFactor * 1.15)) + fieldMargin;

        if (collab.pdfName) {
             if (yPos > 270) { doc.addPage(); yPos = 20; }
             doc.line(20, yPos-3, 190, yPos-3);
             addField("Documento Adjunto", collab.pdfName);
        }
        
        doc.setFontSize(8); doc.setTextColor(150,150,150);
        doc.text(`Ficha generada por ${AGENT_INFO.companyName}`, 105, 288, { align: 'center' });
        doc.save(`Ficha_Colaborador_${collab.collaboratorName.replace(/\s+/g, '_')}.pdf`);
    }


    function exportDBtoJSON() {
        const dataToExport = {
            clients: clients,
            properties: properties,
            collaborators: collaborators,
            privateSellers: privateSellers // NEW
        };
        const jsonData = JSON.stringify(dataToExport, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'mercat_immobiliari_backup.json'; // Updated filename
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert(`Base de datos completa exportada a JSON. (${AGENT_INFO.companyName})`);
    }

    function handleJSONImport(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (confirm(`¿Está seguro de que desea reemplazar la base de datos actual con los datos del archivo JSON? Esta acción no se puede deshacer. (${AGENT_INFO.companyName})`)) {
                        clients = Array.isArray(importedData.clients) ? importedData.clients : [];
                        properties = Array.isArray(importedData.properties) ? importedData.properties : [];
                        collaborators = Array.isArray(importedData.collaborators) ? importedData.collaborators : [];
                        privateSellers = Array.isArray(importedData.privateSellers) ? importedData.privateSellers : []; // NEW
                        
                        loadClients(); 
                        loadProperties(); 
                        loadCollaborators();
                        loadPrivateSellers(); // NEW

                        saveClientsToLocalStorage();
                        savePropertiesToLocalStorage();
                        saveCollaboratorsToLocalStorage();
                        savePrivateSellersToLocalStorage(); // NEW

                        updateClientsTable();
                        updatePropertiesTable();
                        updateCollaboratorsTable();
                        updatePrivateSellersTable(); // NEW

                        prepareNewClientForm();
                        prepareNewPropertyForm();
                        prepareNewCollaboratorForm();
                        prepareNewPrivateSellerForm(); // NEW
                        alert(`Base de datos importada correctamente desde JSON. (${AGENT_INFO.companyName})`);
                    }
                } catch (error) {
                    alert(`Error al procesar el archivo JSON: ${error.message} (${AGENT_INFO.companyName})`);
                } finally {
                    event.target.value = null; 
                }
            };
            reader.readAsText(file);
        }
    }
    
    const valueToKeyMappings = { 
        mortgageApproved: { 'Sí': 'si', 'No': 'no', 'En Proceso': 'en_proceso', 'No Necesita': 'no_necesita' },
        clientStatus: { 'Activo': 'activo', 'No Activo': 'no_activo', 'Seguimiento': 'seguimiento', 'Descartado': 'descartado' },
        elevator: { 
            'Sí, es indispensable': 'si', 
            'Sí Tiene': 'si',
            'No es indispensable (OK sin él)': 'no',
            'No Tiene': 'no',
            'No indisp. hasta 1º': 'no_indispensable_1',
            'No indisp. hasta 2º': 'no_indispensable_2',
            'No indisp. hasta 3º': 'no_indispensable_3',
            'No indisp. hasta 4º': 'no_indispensable_4',
            'Indiferente / No especificado': 'indiferente',
            'Indiferente / No consta': 'indiferente',
            'Indiferente': 'indiferente'
        },
        sellerType: {
            'Particular (Captación propia)': 'particular', 
            'Agencia (Colaborador)': 'agencia',
            'Particular': 'particular', // For backward compatibility if old data exists
            'Agencia': 'agencia' // For backward compatibility
        },
        privateSellerStatus: {
            'Seguimiento': 'seguimiento',
            'Contactado (Interesado)': 'activo',
            'Contactado (No Interesado)': 'no_activo',
            'Descartado / Vendido por otro': 'descartado'
        }
    };


    function exportDBtoXLSX() {
        const wb = XLSX.utils.book_new();

        const clientsDataForExport = clients.map(client => ({
            [XLSX_HEADERS_CLIENTS[0]]: client.id,
            [XLSX_HEADERS_CLIENTS[1]]: client.name,
            [XLSX_HEADERS_CLIENTS[2]]: client.phone,
            [XLSX_HEADERS_CLIENTS[3]]: client.email,
            [XLSX_HEADERS_CLIENTS[4]]: client.priceMax,
            [XLSX_HEADERS_CLIENTS[5]]: client.contribution,
            [XLSX_HEADERS_CLIENTS[6]]: client.zone,
            [XLSX_HEADERS_CLIENTS[7]]: getStatusText(client.mortgageApproved, 'mortgage'),
            [XLSX_HEADERS_CLIENTS[8]]: getStatusText(client.status, 'clientStatus'),
            [XLSX_HEADERS_CLIENTS[9]]: client.numRooms,
            [XLSX_HEADERS_CLIENTS[10]]: getStatusText(client.elevator, 'elevator'),
            [XLSX_HEADERS_CLIENTS[11]]: client.minSqMeters,
            [XLSX_HEADERS_CLIENTS[12]]: client.maxSqMeters,
            [XLSX_HEADERS_CLIENTS[13]]: client.comments,
            [XLSX_HEADERS_CLIENTS[14]]: client.pdfName
        }));
        const wsClients = XLSX.utils.json_to_sheet(clientsDataForExport, {header: XLSX_HEADERS_CLIENTS});
        XLSX.utils.book_append_sheet(wb, wsClients, "Clientes Compradores");

        const propertiesDataForExport = properties.map(prop => ({
            [XLSX_HEADERS_PROPERTIES[0]]: prop.id,
            [XLSX_HEADERS_PROPERTIES[1]]: prop.address,
            [XLSX_HEADERS_PROPERTIES[2]]: prop.price,
            [XLSX_HEADERS_PROPERTIES[3]]: prop.sellerName,
            [XLSX_HEADERS_PROPERTIES[4]]: prop.sellerPhone,
            [XLSX_HEADERS_PROPERTIES[5]]: getStatusText(prop.sellerType, 'sellerType'),
            [XLSX_HEADERS_PROPERTIES[6]]: prop.propertyFloor,
            [XLSX_HEADERS_PROPERTIES[7]]: prop.sqMeters,
            [XLSX_HEADERS_PROPERTIES[8]]: prop.rooms,
            [XLSX_HEADERS_PROPERTIES[9]]: prop.baths,
            [XLSX_HEADERS_PROPERTIES[10]]: getStatusText(prop.elevator, 'propertyElevator'),
            [XLSX_HEADERS_PROPERTIES[11]]: prop.propertyURL,
            [XLSX_HEADERS_PROPERTIES[12]]: prop.comments,
            [XLSX_HEADERS_PROPERTIES[13]]: prop.imageName 
        }));
        const wsProperties = XLSX.utils.json_to_sheet(propertiesDataForExport, {header: XLSX_HEADERS_PROPERTIES});
        XLSX.utils.book_append_sheet(wb, wsProperties, "Propiedades (Captadas-Colab)");

        const collaboratorsDataForExport = collaborators.map(collab => ({
            [XLSX_HEADERS_COLLABORATORS[0]]: collab.id,
            [XLSX_HEADERS_COLLABORATORS[1]]: collab.collaboratorName,
            [XLSX_HEADERS_COLLABORATORS[2]]: collab.agencyName,
            [XLSX_HEADERS_COLLABORATORS[3]]: collab.phone,
            [XLSX_HEADERS_COLLABORATORS[4]]: collab.email,
            [XLSX_HEADERS_COLLABORATORS[5]]: collab.address,
            [XLSX_HEADERS_COLLABORATORS[6]]: collab.url,
            [XLSX_HEADERS_COLLABORATORS[7]]: collab.comments,
            [XLSX_HEADERS_COLLABORATORS[8]]: collab.pdfName || ''
        }));
        const wsCollaborators = XLSX.utils.json_to_sheet(collaboratorsDataForExport, {header: XLSX_HEADERS_COLLABORATORS});
        XLSX.utils.book_append_sheet(wb, wsCollaborators, "Colaboradores");

        const privateSellersDataForExport = privateSellers.map(ps => ({ // NEW
            [XLSX_HEADERS_PRIVATE_SELLERS[0]]: ps.id,
            [XLSX_HEADERS_PRIVATE_SELLERS[1]]: ps.ownerName,
            [XLSX_HEADERS_PRIVATE_SELLERS[2]]: ps.ownerPhone,
            [XLSX_HEADERS_PRIVATE_SELLERS[3]]: ps.ownerEmail,
            [XLSX_HEADERS_PRIVATE_SELLERS[4]]: ps.propertyAddress,
            [XLSX_HEADERS_PRIVATE_SELLERS[5]]: ps.propertyZone,
            [XLSX_HEADERS_PRIVATE_SELLERS[6]]: ps.propertyFloor,
            [XLSX_HEADERS_PRIVATE_SELLERS[7]]: ps.propertyRooms,
            [XLSX_HEADERS_PRIVATE_SELLERS[8]]: ps.propertySqMeters,
            [XLSX_HEADERS_PRIVATE_SELLERS[9]]: getStatusText(ps.propertyElevator, 'propertyElevator'),
            [XLSX_HEADERS_PRIVATE_SELLERS[10]]: ps.propertyURL,
            [XLSX_HEADERS_PRIVATE_SELLERS[11]]: getStatusText(ps.status, 'privateSellerStatus'),
            [XLSX_HEADERS_PRIVATE_SELLERS[12]]: ps.comments,
            [XLSX_HEADERS_PRIVATE_SELLERS[13]]: ps.propertyImageName
        }));
        const wsPrivateSellers = XLSX.utils.json_to_sheet(privateSellersDataForExport, {header: XLSX_HEADERS_PRIVATE_SELLERS});
        XLSX.utils.book_append_sheet(wb, wsPrivateSellers, "Seguimiento Particulares");


        XLSX.writeFile(wb, "mercat_immobiliari_backup.xlsx"); // Updated filename
        alert(`Base de datos completa exportada a XLSX. (${AGENT_INFO.companyName})`);
    }
    
    function mapImportedXLSXValue(value, fieldType, headerMappingsToUse) {
        if (value === undefined || value === null || String(value).trim() === '') {
            if (fieldType === 'elevator' || fieldType === 'propertyElevator') return 'indiferente'; 
            if (fieldType === 'mortgageApproved') return 'no'; 
            if (fieldType === 'clientStatus' || fieldType === 'privateSellerStatus') return 'seguimiento'; 
            if (fieldType === 'sellerType') return 'particular'; 
            return null;
        }
        
        const map = headerMappingsToUse[fieldType]; 
        if (map) {
            const valStr = String(value).trim().toLowerCase();
            for (const key in map) {
                if (map[key].toLowerCase() === valStr) {
                    return key;
                }
            }
            // Fallback for partial matches or common variations
            if (valStr === 'si' || valStr === 'sí' || valStr === 'yes') return 'si';
            if (valStr === 'no') return 'no';

            return String(value).trim().toLowerCase().replace(/\s+/g, '_').replace(/\//g, '_');
        }
        return String(value).trim();
    }

    function handleXLSXImport(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    if (confirm(`¿Está seguro de que desea reemplazar la base de datos actual con los datos del archivo XLSX? Esta acción no se puede deshacer. (${AGENT_INFO.companyName})`)) {
                        // CLIENTS
                        if (workbook.SheetNames.includes("Clientes Compradores")) {
                            const ws = workbook.Sheets["Clientes Compradores"];
                            const jsonData = XLSX.utils.sheet_to_json(ws, {header:1});
                            if (jsonData.length > 1) {
                                const headers = jsonData[0];
                                clients = jsonData.slice(1).map(rowData => {
                                    let client = { pdfData: null }; // Ensure pdfData starts null
                                    XLSX_HEADERS_CLIENTS.forEach((expectedHeader, index) => {
                                        const actualHeaderIndex = headers.findIndex(h => String(h).trim() === String(expectedHeader).trim());
                                        const val = actualHeaderIndex !== -1 ? rowData[actualHeaderIndex] : undefined;
                                        
                                        if (expectedHeader === XLSX_HEADERS_CLIENTS[0]) client.id = String(val || Date.now().toString() + Math.random().toString(16).slice(2));
                                        else if (expectedHeader === XLSX_HEADERS_CLIENTS[1]) client.name = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_CLIENTS[2]) client.phone = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_CLIENTS[3]) client.email = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_CLIENTS[4]) client.priceMax = parseFloat(val) || 0;
                                        else if (expectedHeader === XLSX_HEADERS_CLIENTS[5]) client.contribution = parseFloat(val) || 0;
                                        else if (expectedHeader === XLSX_HEADERS_CLIENTS[6]) client.zone = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_CLIENTS[7]) client.mortgageApproved = mapImportedXLSXValue(val, 'mortgageApproved', valueToKeyMappings) || 'no';
                                        else if (expectedHeader === XLSX_HEADERS_CLIENTS[8]) client.status = mapImportedXLSXValue(val, 'clientStatus', valueToKeyMappings) || 'seguimiento';
                                        else if (expectedHeader === XLSX_HEADERS_CLIENTS[9]) client.numRooms = val !== undefined && val !== null ? String(val) : null;
                                        else if (expectedHeader === XLSX_HEADERS_CLIENTS[10]) client.elevator = mapImportedXLSXValue(val, 'elevator', valueToKeyMappings) || 'indiferente';
                                        else if (expectedHeader === XLSX_HEADERS_CLIENTS[11]) client.minSqMeters = val !== undefined && val !== null && String(val).trim() !== '' ? parseInt(val) : null;
                                        else if (expectedHeader === XLSX_HEADERS_CLIENTS[12]) client.maxSqMeters = val !== undefined && val !== null && String(val).trim() !== '' ? parseInt(val) : null;
                                        else if (expectedHeader === XLSX_HEADERS_CLIENTS[13]) client.comments = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_CLIENTS[14]) client.pdfName = String(val || '') || null;
                                    });
                                    return (client.id && client.name) ? client : null;
                                }).filter(Boolean);
                            }
                        } else { console.warn("Hoja 'Clientes Compradores' no encontrada en XLSX."); clients = []; }

                        // PROPERTIES
                        if (workbook.SheetNames.includes("Propiedades (Captadas-Colab)")) {
                            const ws = workbook.Sheets["Propiedades (Captadas-Colab)"];
                            const jsonData = XLSX.utils.sheet_to_json(ws, {header:1});
                            if (jsonData.length > 1) {
                                const headers = jsonData[0];
                                properties = jsonData.slice(1).map(rowData => {
                                    let prop = { image: null };
                                     XLSX_HEADERS_PROPERTIES.forEach((expectedHeader) => {
                                        const actualHeaderIndex = headers.findIndex(h => String(h).trim() === String(expectedHeader).trim());
                                        const val = actualHeaderIndex !== -1 ? rowData[actualHeaderIndex] : undefined;

                                        if (expectedHeader === XLSX_HEADERS_PROPERTIES[0]) prop.id = String(val || Date.now().toString() + Math.random().toString(16).slice(2));
                                        else if (expectedHeader === XLSX_HEADERS_PROPERTIES[1]) prop.address = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_PROPERTIES[2]) prop.price = parseFloat(val) || 0;
                                        else if (expectedHeader === XLSX_HEADERS_PROPERTIES[3]) prop.sellerName = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_PROPERTIES[4]) prop.sellerPhone = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_PROPERTIES[5]) prop.sellerType = mapImportedXLSXValue(val, 'sellerType', valueToKeyMappings) || 'particular';
                                        else if (expectedHeader === XLSX_HEADERS_PROPERTIES[6]) prop.propertyFloor = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_PROPERTIES[7]) prop.sqMeters = parseFloat(val) || 0;
                                        else if (expectedHeader === XLSX_HEADERS_PROPERTIES[8]) prop.rooms = parseInt(val) || 0;
                                        else if (expectedHeader === XLSX_HEADERS_PROPERTIES[9]) prop.baths = parseInt(val) || 0;
                                        else if (expectedHeader === XLSX_HEADERS_PROPERTIES[10]) prop.elevator = mapImportedXLSXValue(val, 'propertyElevator', valueToKeyMappings) || 'indiferente'; 
                                        else if (expectedHeader === XLSX_HEADERS_PROPERTIES[11]) prop.propertyURL = String(val || '') || null;
                                        else if (expectedHeader === XLSX_HEADERS_PROPERTIES[12]) prop.comments = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_PROPERTIES[13]) prop.imageName = String(val || '') || null;
                                     });
                                    return (prop.id && prop.address) ? prop : null;
                                }).filter(Boolean);
                            }
                        } else { console.warn("Hoja 'Propiedades (Captadas-Colab)' no encontrada en XLSX."); properties = []; }
                        
                        // COLLABORATORS
                        if (workbook.SheetNames.includes("Colaboradores")) {
                            const ws = workbook.Sheets["Colaboradores"];
                            const jsonData = XLSX.utils.sheet_to_json(ws, {header:1});
                            if (jsonData.length > 1) {
                                const headers = jsonData[0];
                                collaborators = jsonData.slice(1).map(rowData => {
                                    let collab = { pdfData: null };
                                    XLSX_HEADERS_COLLABORATORS.forEach((expectedHeader) => {
                                        const actualHeaderIndex = headers.findIndex(h => String(h).trim() === String(expectedHeader).trim());
                                        const val = actualHeaderIndex !== -1 ? rowData[actualHeaderIndex] : undefined;

                                        if (expectedHeader === XLSX_HEADERS_COLLABORATORS[0]) collab.id = String(val || Date.now().toString() + Math.random().toString(16).slice(2));
                                        else if (expectedHeader === XLSX_HEADERS_COLLABORATORS[1]) collab.collaboratorName = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_COLLABORATORS[2]) collab.agencyName = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_COLLABORATORS[3]) collab.phone = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_COLLABORATORS[4]) collab.email = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_COLLABORATORS[5]) collab.address = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_COLLABORATORS[6]) collab.url = String(val || '') || null;
                                        else if (expectedHeader === XLSX_HEADERS_COLLABORATORS[7]) collab.comments = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_COLLABORATORS[8]) collab.pdfName = String(val || '') || null;
                                    });
                                    return (collab.id && collab.collaboratorName) ? collab : null;
                                }).filter(Boolean);
                            }
                        } else { console.warn("Hoja 'Colaboradores' no encontrada en XLSX."); collaborators = []; }

                        // PRIVATE SELLERS (NEW)
                        if (workbook.SheetNames.includes("Seguimiento Particulares")) {
                            const ws = workbook.Sheets["Seguimiento Particulares"];
                            const jsonData = XLSX.utils.sheet_to_json(ws, {header:1});
                            if (jsonData.length > 1) {
                                const headers = jsonData[0];
                                privateSellers = jsonData.slice(1).map(rowData => {
                                    let ps = { propertyImage: null };
                                    XLSX_HEADERS_PRIVATE_SELLERS.forEach((expectedHeader) => {
                                        const actualHeaderIndex = headers.findIndex(h => String(h).trim() === String(expectedHeader).trim());
                                        const val = actualHeaderIndex !== -1 ? rowData[actualHeaderIndex] : undefined;

                                        if (expectedHeader === XLSX_HEADERS_PRIVATE_SELLERS[0]) ps.id = String(val || Date.now().toString() + Math.random().toString(16).slice(2));
                                        else if (expectedHeader === XLSX_HEADERS_PRIVATE_SELLERS[1]) ps.ownerName = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_PRIVATE_SELLERS[2]) ps.ownerPhone = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_PRIVATE_SELLERS[3]) ps.ownerEmail = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_PRIVATE_SELLERS[4]) ps.propertyAddress = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_PRIVATE_SELLERS[5]) ps.propertyZone = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_PRIVATE_SELLERS[6]) ps.propertyFloor = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_PRIVATE_SELLERS[7]) ps.propertyRooms = parseInt(val) || 0;
                                        else if (expectedHeader === XLSX_HEADERS_PRIVATE_SELLERS[8]) ps.propertySqMeters = parseFloat(val) || 0;
                                        else if (expectedHeader === XLSX_HEADERS_PRIVATE_SELLERS[9]) ps.propertyElevator = mapImportedXLSXValue(val, 'propertyElevator', valueToKeyMappings) || 'indiferente';
                                        else if (expectedHeader === XLSX_HEADERS_PRIVATE_SELLERS[10]) ps.propertyURL = String(val || '') || null;
                                        else if (expectedHeader === XLSX_HEADERS_PRIVATE_SELLERS[11]) ps.status = mapImportedXLSXValue(val, 'privateSellerStatus', valueToKeyMappings) || 'seguimiento';
                                        else if (expectedHeader === XLSX_HEADERS_PRIVATE_SELLERS[12]) ps.comments = String(val || '');
                                        else if (expectedHeader === XLSX_HEADERS_PRIVATE_SELLERS[13]) ps.propertyImageName = String(val || '') || null;
                                    });
                                    return (ps.id && ps.ownerName && ps.propertyAddress) ? ps : null;
                                }).filter(Boolean);
                            }
                        } else { console.warn("Hoja 'Seguimiento Particulares' no encontrada en XLSX."); privateSellers = []; }


                        saveClientsToLocalStorage();
                        savePropertiesToLocalStorage();
                        saveCollaboratorsToLocalStorage();
                        savePrivateSellersToLocalStorage(); // NEW

                        updateClientsTable();
                        updatePropertiesTable();
                        updateCollaboratorsTable();
                        updatePrivateSellersTable(); // NEW

                        prepareNewClientForm();
                        prepareNewPropertyForm();
                        prepareNewCollaboratorForm();
                        prepareNewPrivateSellerForm(); // NEW
                        alert(`Base de datos importada desde XLSX. (${AGENT_INFO.companyName})`);
                    }
                } catch (error) {
                    console.error("Error processing XLSX file:", error);
                    alert(`Error al procesar el archivo XLSX: ${error.message} (${AGENT_INFO.companyName})`);
                } finally {
                    event.target.value = null; 
                }
            };
            reader.readAsArrayBuffer(file);
        }
    }

    function sharePropertyViaWhatsApp(clientId, propertyId) {
        const client = clients.find(c => c.id === clientId);
        const prop = properties.find(p => p.id === propertyId);

        if (!client || !prop) {
            alert(`Error: No se pudo encontrar el cliente o la propiedad para compartir. (${AGENT_INFO.companyName})`);
            return;
        }

        if (!client.phone || client.phone.trim() === "") {
            alert(`El cliente "${client.name}" no tiene un número de teléfono registrado. Por favor, añádelo en su ficha. (${AGENT_INFO.companyName})`);
            return;
        }

        let phoneNumber = client.phone.replace(/\s+/g, '').replace(/[^0-9+]/g, ''); 
        if (phoneNumber.startsWith('+')) {
            phoneNumber = phoneNumber.substring(1); 
        }
        if (phoneNumber.length === 9 && !phoneNumber.startsWith('34')) {
            phoneNumber = '34' + phoneNumber;
        }

        let message = `¡Hola ${client.name}!\n\n`;
        message += `Soy ${AGENT_INFO.name} de ${AGENT_INFO.companyName}. Quería compartir contigo esta propiedad que podría encajar con lo que buscas:\n\n`;
        message += `🏡 *Propiedad:* ${prop.address}${prop.propertyFloor ? ' ('+prop.propertyFloor+')' : ''}\n`;
        message += `💰 *Precio:* ${formatCurrency(prop.price)}\n`;
        message += `🚪 *Habitaciones:* ${prop.rooms === 0 ? 'Estudio' : (prop.rooms || 'N/A')}\n`;
        if (prop.baths) {
            message += `🚽 *Baños:* ${prop.baths || 'N/A'}\n`;
        }
        message += `🔼 *Ascensor:* ${getStatusText(prop.elevator, 'propertyElevator')}\n`;
        if (prop.sqMeters) {
            message += `📏 *Superficie:* ${prop.sqMeters} m²\n`;
        }

        if (prop.propertyURL) {
            let url = prop.propertyURL;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }
            message += `\n🔗 *Puedes ver más detalles o el anuncio aquí:*\n${url}\n`;
        }

        message += `\nSi te interesa o quieres que veamos más opciones, no dudes en decírmelo.\n\n`;
        message += `¡Un saludo!\n${AGENT_INFO.name}\n${AGENT_INFO.companyName}\nTel: ${AGENT_INFO.phone}`;

        const encodedMessage = encodeURIComponent(message);
        const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;

        window.open(whatsappURL, '_blank');
    }

</script>
